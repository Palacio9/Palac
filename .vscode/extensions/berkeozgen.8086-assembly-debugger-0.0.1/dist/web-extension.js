var _i=Object.create;var Mt=Object.defineProperty;var Fi=Object.getOwnPropertyDescriptor;var Ui=Object.getOwnPropertyNames;var Mi=Object.getPrototypeOf,zi=Object.prototype.hasOwnProperty;var z=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),ji=(s,e)=>{for(var t in e)Mt(s,t,{get:e[t],enumerable:!0})},ln=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ui(e))!zi.call(s,r)&&r!==t&&Mt(s,r,{get:()=>e[r],enumerable:!(n=Fi(e,r))||n.enumerable});return s};var ze=(s,e,t)=>(t=s!=null?_i(Mi(s)):{},ln(e||!s||!s.__esModule?Mt(t,"default",{value:s,enumerable:!0}):t,s)),Wi=s=>ln(Mt({},"__esModule",{value:!0}),s);var ws=z((To,Ds)=>{"use strict";var tt=typeof Reflect=="object"?Reflect:null,cn=tt&&typeof tt.apply=="function"?tt.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},zt;tt&&typeof tt.ownKeys=="function"?zt=tt.ownKeys:Object.getOwnPropertySymbols?zt=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:zt=function(e){return Object.getOwnPropertyNames(e)};function qi(s){console&&console.warn&&console.warn(s)}var dn=Number.isNaN||function(e){return e!==e};function C(){C.init.call(this)}Ds.exports=C;Ds.exports.once=Xi;C.EventEmitter=C;C.prototype._events=void 0;C.prototype._eventsCount=0;C.prototype._maxListeners=void 0;var hn=10;function jt(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(C,"defaultMaxListeners",{enumerable:!0,get:function(){return hn},set:function(s){if(typeof s!="number"||s<0||dn(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");hn=s}});C.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};C.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||dn(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function pn(s){return s._maxListeners===void 0?C.defaultMaxListeners:s._maxListeners}C.prototype.getMaxListeners=function(){return pn(this)};C.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r=e==="error",u=this._events;if(u!==void 0)r=r&&u.error===void 0;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=u[e];if(c===void 0)return!1;if(typeof c=="function")cn(c,this,t);else for(var d=c.length,p=vn(c,d),n=0;n<d;++n)cn(p[n],this,t);return!0};function fn(s,e,t,n){var r,u,o;if(jt(t),u=s._events,u===void 0?(u=s._events=Object.create(null),s._eventsCount=0):(u.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),u=s._events),o=u[e]),o===void 0)o=u[e]=t,++s._eventsCount;else if(typeof o=="function"?o=u[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),r=pn(s),r>0&&o.length>r&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=s,a.type=e,a.count=o.length,qi(a)}return s}C.prototype.addListener=function(e,t){return fn(this,e,t,!1)};C.prototype.on=C.prototype.addListener;C.prototype.prependListener=function(e,t){return fn(this,e,t,!0)};function Vi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function mn(s,e,t){var n={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},r=Vi.bind(n);return r.listener=t,n.wrapFn=r,r}C.prototype.once=function(e,t){return jt(t),this.on(e,mn(this,e,t)),this};C.prototype.prependOnceListener=function(e,t){return jt(t),this.prependListener(e,mn(this,e,t)),this};C.prototype.removeListener=function(e,t){var n,r,u,o,a;if(jt(t),r=this._events,r===void 0)return this;if(n=r[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(u=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,u=o;break}if(u<0)return this;u===0?n.shift():Gi(n,u),n.length===1&&(r[e]=n[0]),r.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};C.prototype.off=C.prototype.removeListener;C.prototype.removeAllListeners=function(e){var t,n,r;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var u=Object.keys(n),o;for(r=0;r<u.length;++r)o=u[r],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function gn(s,e,t){var n=s._events;if(n===void 0)return[];var r=n[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?Hi(r):vn(r,r.length)}C.prototype.listeners=function(e){return gn(this,e,!0)};C.prototype.rawListeners=function(e){return gn(this,e,!1)};C.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):bn.call(s,e)};C.prototype.listenerCount=bn;function bn(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}C.prototype.eventNames=function(){return this._eventsCount>0?zt(this._events):[]};function vn(s,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=s[n];return t}function Gi(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function Hi(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function Xi(s,e){return new Promise(function(t,n){function r(o){s.removeListener(e,u),n(o)}function u(){typeof s.removeListener=="function"&&s.removeListener("error",r),t([].slice.call(arguments))}yn(s,e,u,{once:!0}),e!=="error"&&$i(s,r,{once:!0})})}function $i(s,e,t){typeof s.on=="function"&&yn(s,"error",e,t)}function yn(s,e,t,n){if(typeof s.on=="function")n.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function r(u){n.once&&s.removeEventListener(e,r),t(u)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}});var qt=z(je=>{"use strict";Object.defineProperty(je,"__esModule",{value:!0});je.Event=je.Response=je.Message=void 0;var Wt=class{constructor(e){this.seq=0,this.type=e}};je.Message=Wt;var Rn=class extends Wt{constructor(e,t){super("response");this.request_seq=e.seq,this.command=e.command,t?(this.success=!1,this.message=t):this.success=!0}};je.Response=Rn;var Dn=class extends Wt{constructor(e,t){super("event");this.event=e,t&&(this.body=t)}};je.Event=Dn});var An=z(Vt=>{"use strict";Object.defineProperty(Vt,"__esModule",{value:!0});Vt.ProtocolServer=void 0;var Ji=ws(),gt=qt(),wn=class{get event(){return this._event||(this._event=(e,t)=>{this._listener=e,this._this=t;let n;return n={dispose:()=>{this._listener=void 0,this._this=void 0}},n}),this._event}fire(e){if(this._listener)try{this._listener.call(this._this,e)}catch{}}hasListener(){return!!this._listener}dispose(){this._listener=void 0,this._this=void 0}},st=class extends Ji.EventEmitter{constructor(){super();this._sendMessage=new wn,this._pendingRequests=new Map,this.onDidSendMessage=this._sendMessage.event}dispose(){}handleMessage(e){if(e.type==="request")this.dispatchRequest(e);else if(e.type==="response"){let t=e,n=this._pendingRequests.get(t.request_seq);n&&(this._pendingRequests.delete(t.request_seq),n(t))}}_isRunningInline(){return this._sendMessage&&this._sendMessage.hasListener()}start(e,t){this._sequence=1,this._writableStream=t,this._rawData=Buffer.alloc(0),e.on("data",n=>this._handleData(n)),e.on("close",()=>{this._emitEvent(new gt.Event("close"))}),e.on("error",n=>{this._emitEvent(new gt.Event("error","inStream error: "+(n&&n.message)))}),t.on("error",n=>{this._emitEvent(new gt.Event("error","outStream error: "+(n&&n.message)))}),e.resume()}stop(){this._writableStream&&this._writableStream.end()}sendEvent(e){this._send("event",e)}sendResponse(e){e.seq>0?console.error(`attempt to send more than one response for command ${e.command}`):this._send("response",e)}sendRequest(e,t,n,r){let u={command:e};if(t&&Object.keys(t).length>0&&(u.arguments=t),this._send("request",u),r){this._pendingRequests.set(u.seq,r);let o=setTimeout(()=>{clearTimeout(o);let a=this._pendingRequests.get(u.seq);a&&(this._pendingRequests.delete(u.seq),a(new gt.Response(u,"timeout")))},n)}}dispatchRequest(e){}_emitEvent(e){this.emit(e.event,e)}_send(e,t){if(t.type=e,t.seq=this._sequence++,this._writableStream){let n=JSON.stringify(t);this._writableStream.write(`Content-Length: ${Buffer.byteLength(n,"utf8")}\r
\r
${n}`,"utf8")}this._sendMessage.fire(t)}_handleData(e){for(this._rawData=Buffer.concat([this._rawData,e]);;){if(this._contentLength>=0){if(this._rawData.length>=this._contentLength){let t=this._rawData.toString("utf8",0,this._contentLength);if(this._rawData=this._rawData.slice(this._contentLength),this._contentLength=-1,t.length>0)try{let n=JSON.parse(t);this.handleMessage(n)}catch(n){this._emitEvent(new gt.Event("error","Error handling data: "+(n&&n.message)))}continue}}else{let t=this._rawData.indexOf(st.TWO_CRLF);if(t!==-1){let r=this._rawData.toString("utf8",0,t).split(`\r
`);for(let u=0;u<r.length;u++){let o=r[u].split(/: +/);o[0]=="Content-Length"&&(this._contentLength=+o[1])}this._rawData=this._rawData.slice(t+st.TWO_CRLF.length);continue}}break}}};Vt.ProtocolServer=st;st.TWO_CRLF=`\r
\r
`});var xn=z(Gt=>{"use strict";Object.defineProperty(Gt,"__esModule",{value:!0});Gt.runDebugAdapter=void 0;function Ki(){}Gt.runDebugAdapter=Ki});var En=z((nt,rt)=>{(function(s){var e=typeof nt=="object"&&nt&&!nt.nodeType&&nt,t=typeof rt=="object"&&rt&&!rt.nodeType&&rt,n=typeof global=="object"&&global;(n.global===n||n.window===n||n.self===n)&&(s=n);var r,u=2147483647,o=36,a=1,c=26,d=38,p=700,b=72,f=128,y="-",x=/^xn--/,S=/[^\x20-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,F={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},m=o-a,w=Math.floor,O=String.fromCharCode,P;function k(R){throw RangeError(F[R])}function pe(R,A){for(var I=R.length,_=[];I--;)_[I]=A(R[I]);return _}function oe(R,A){var I=R.split("@"),_="";I.length>1&&(_=I[0]+"@",R=I[1]),R=R.replace(h,".");var M=R.split("."),Q=pe(M,A).join(".");return _+Q}function K(R){for(var A=[],I=0,_=R.length,M,Q;I<_;)M=R.charCodeAt(I++),M>=55296&&M<=56319&&I<_?(Q=R.charCodeAt(I++),(Q&64512)==56320?A.push(((M&1023)<<10)+(Q&1023)+65536):(A.push(M),I--)):A.push(M);return A}function ve(R){return pe(R,function(A){var I="";return A>65535&&(A-=65536,I+=O(A>>>10&1023|55296),A=56320|A&1023),I+=O(A),I}).join("")}function Je(R){return R-48<10?R-22:R-65<26?R-65:R-97<26?R-97:o}function Ue(R,A){return R+22+75*(R<26)-((A!=0)<<5)}function te(R,A,I){var _=0;for(R=I?w(R/p):R>>1,R+=w(R/A);R>m*c>>1;_+=o)R=w(R/m);return w(_+(m+1)*R/(R+d))}function xe(R){var A=[],I=R.length,_,M=0,Q=f,G=b,ae,ye,Ee,Ne,$,fe,Re,Me,Ke;for(ae=R.lastIndexOf(y),ae<0&&(ae=0),ye=0;ye<ae;++ye)R.charCodeAt(ye)>=128&&k("not-basic"),A.push(R.charCodeAt(ye));for(Ee=ae>0?ae+1:0;Ee<I;){for(Ne=M,$=1,fe=o;Ee>=I&&k("invalid-input"),Re=Je(R.charCodeAt(Ee++)),(Re>=o||Re>w((u-M)/$))&&k("overflow"),M+=Re*$,Me=fe<=G?a:fe>=G+c?c:fe-G,!(Re<Me);fe+=o)Ke=o-Me,$>w(u/Ke)&&k("overflow"),$*=Ke;_=A.length+1,G=te(M-Ne,_,Ne==0),w(M/_)>u-Q&&k("overflow"),Q+=w(M/_),M%=_,A.splice(M++,0,Q)}return ve(A)}function Oe(R){var A,I,_,M,Q,G,ae,ye,Ee,Ne,$,fe=[],Re,Me,Ke,Rs;for(R=K(R),Re=R.length,A=f,I=0,Q=b,G=0;G<Re;++G)$=R[G],$<128&&fe.push(O($));for(_=M=fe.length,M&&fe.push(y);_<Re;){for(ae=u,G=0;G<Re;++G)$=R[G],$>=A&&$<ae&&(ae=$);for(Me=_+1,ae-A>w((u-I)/Me)&&k("overflow"),I+=(ae-A)*Me,A=ae,G=0;G<Re;++G)if($=R[G],$<A&&++I>u&&k("overflow"),$==A){for(ye=I,Ee=o;Ne=Ee<=Q?a:Ee>=Q+c?c:Ee-Q,!(ye<Ne);Ee+=o)Rs=ye-Ne,Ke=o-Ne,fe.push(O(Ue(Ne+Rs%Ke,0))),ye=w(Rs/Ke);fe.push(O(Ue(ye,0))),Q=te(I,Me,_==M),I=0,++_}++I,++A}return fe.join("")}function Be(R){return oe(R,function(A){return x.test(A)?xe(A.slice(4).toLowerCase()):A})}function Te(R){return oe(R,function(A){return S.test(A)?"xn--"+Oe(A):A})}if(r={version:"1.3.2",ucs2:{decode:K,encode:ve},decode:xe,encode:Oe,toASCII:Te,toUnicode:Be},typeof define=="function"&&typeof define.amd=="object"&&define.amd)define("punycode",function(){return r});else if(e&&t)if(rt.exports==e)t.exports=r;else for(P in r)r.hasOwnProperty(P)&&(e[P]=r[P]);else s.punycode=r})(nt)});var In=z((Uo,Sn)=>{"use strict";Sn.exports={isString:function(s){return typeof s=="string"},isObject:function(s){return typeof s=="object"&&s!==null},isNull:function(s){return s===null},isNullOrUndefined:function(s){return s==null}}});var Pn=z((Mo,Ln)=>{"use strict";function Qi(s,e){return Object.prototype.hasOwnProperty.call(s,e)}Ln.exports=function(s,e,t,n){e=e||"&",t=t||"=";var r={};if(typeof s!="string"||s.length===0)return r;var u=/\+/g;s=s.split(e);var o=1e3;n&&typeof n.maxKeys=="number"&&(o=n.maxKeys);var a=s.length;o>0&&a>o&&(a=o);for(var c=0;c<a;++c){var d=s[c].replace(u,"%20"),p=d.indexOf(t),b,f,y,x;p>=0?(b=d.substr(0,p),f=d.substr(p+1)):(b=d,f=""),y=decodeURIComponent(b),x=decodeURIComponent(f),Qi(r,y)?Array.isArray(r[y])?r[y].push(x):r[y]=[r[y],x]:r[y]=x}return r}});var kn=z((zo,Cn)=>{"use strict";var bt=function(s){switch(typeof s){case"string":return s;case"boolean":return s?"true":"false";case"number":return isFinite(s)?s:"";default:return""}};Cn.exports=function(s,e,t,n){return e=e||"&",t=t||"=",s===null&&(s=void 0),typeof s=="object"?Object.keys(s).map(function(r){var u=encodeURIComponent(bt(r))+t;return Array.isArray(s[r])?s[r].map(function(o){return u+encodeURIComponent(bt(o))}).join(e):u+encodeURIComponent(bt(s[r]))}).join(e):n?encodeURIComponent(bt(n))+t+encodeURIComponent(bt(s)):""}});var On=z(vt=>{"use strict";vt.decode=vt.parse=Pn();vt.encode=vt.stringify=kn()});var _n=z(ot=>{"use strict";var Zi=En(),Se=In();ot.parse=yt;ot.resolve=uo;ot.resolveObject=lo;ot.format=ao;ot.Url=me;function me(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var Yi=/^([a-z0-9.+-]+:)/i,eo=/:[0-9]*$/,to=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,so=["<",">",'"',"`"," ","\r",`
`,"	"],no=["{","}","|","\\","^","`"].concat(so),As=["'"].concat(no),Bn=["%","/","?",";","#"].concat(As),Tn=["/","?","#"],ro=255,Nn=/^[+a-z0-9A-Z_-]{0,63}$/,io=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,oo={javascript:!0,"javascript:":!0},xs={javascript:!0,"javascript:":!0},it={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},Es=On();function yt(s,e,t){if(s&&Se.isObject(s)&&s instanceof me)return s;var n=new me;return n.parse(s,e,t),n}me.prototype.parse=function(s,e,t){if(!Se.isString(s))throw new TypeError("Parameter 'url' must be a string, not "+typeof s);var n=s.indexOf("?"),r=n!==-1&&n<s.indexOf("#")?"?":"#",u=s.split(r),o=/\\/g;u[0]=u[0].replace(o,"/"),s=u.join(r);var a=s;if(a=a.trim(),!t&&s.split("#").length===1){var c=to.exec(a);if(c)return this.path=a,this.href=a,this.pathname=c[1],c[2]?(this.search=c[2],e?this.query=Es.parse(this.search.substr(1)):this.query=this.search.substr(1)):e&&(this.search="",this.query={}),this}var d=Yi.exec(a);if(d){d=d[0];var p=d.toLowerCase();this.protocol=p,a=a.substr(d.length)}if(t||d||a.match(/^\/\/[^@\/]+@[^@\/]+/)){var b=a.substr(0,2)==="//";b&&!(d&&xs[d])&&(a=a.substr(2),this.slashes=!0)}if(!xs[d]&&(b||d&&!it[d])){for(var f=-1,y=0;y<Tn.length;y++){var x=a.indexOf(Tn[y]);x!==-1&&(f===-1||x<f)&&(f=x)}var S,h;f===-1?h=a.lastIndexOf("@"):h=a.lastIndexOf("@",f),h!==-1&&(S=a.slice(0,h),a=a.slice(h+1),this.auth=decodeURIComponent(S)),f=-1;for(var y=0;y<Bn.length;y++){var x=a.indexOf(Bn[y]);x!==-1&&(f===-1||x<f)&&(f=x)}f===-1&&(f=a.length),this.host=a.slice(0,f),a=a.slice(f),this.parseHost(),this.hostname=this.hostname||"";var F=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!F)for(var m=this.hostname.split(/\./),y=0,w=m.length;y<w;y++){var O=m[y];if(!!O&&!O.match(Nn)){for(var P="",k=0,pe=O.length;k<pe;k++)O.charCodeAt(k)>127?P+="x":P+=O[k];if(!P.match(Nn)){var oe=m.slice(0,y),K=m.slice(y+1),ve=O.match(io);ve&&(oe.push(ve[1]),K.unshift(ve[2])),K.length&&(a="/"+K.join(".")+a),this.hostname=oe.join(".");break}}}this.hostname.length>ro?this.hostname="":this.hostname=this.hostname.toLowerCase(),F||(this.hostname=Zi.toASCII(this.hostname));var Je=this.port?":"+this.port:"",Ue=this.hostname||"";this.host=Ue+Je,this.href+=this.host,F&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),a[0]!=="/"&&(a="/"+a))}if(!oo[p])for(var y=0,w=As.length;y<w;y++){var te=As[y];if(a.indexOf(te)!==-1){var xe=encodeURIComponent(te);xe===te&&(xe=escape(te)),a=a.split(te).join(xe)}}var Oe=a.indexOf("#");Oe!==-1&&(this.hash=a.substr(Oe),a=a.slice(0,Oe));var Be=a.indexOf("?");if(Be!==-1?(this.search=a.substr(Be),this.query=a.substr(Be+1),e&&(this.query=Es.parse(this.query)),a=a.slice(0,Be)):e&&(this.search="",this.query={}),a&&(this.pathname=a),it[p]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var Je=this.pathname||"",Te=this.search||"";this.path=Je+Te}return this.href=this.format(),this};function ao(s){return Se.isString(s)&&(s=yt(s)),s instanceof me?s.format():me.prototype.format.call(s)}me.prototype.format=function(){var s=this.auth||"";s&&(s=encodeURIComponent(s),s=s.replace(/%3A/i,":"),s+="@");var e=this.protocol||"",t=this.pathname||"",n=this.hash||"",r=!1,u="";this.host?r=s+this.host:this.hostname&&(r=s+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(r+=":"+this.port)),this.query&&Se.isObject(this.query)&&Object.keys(this.query).length&&(u=Es.stringify(this.query));var o=this.search||u&&"?"+u||"";return e&&e.substr(-1)!==":"&&(e+=":"),this.slashes||(!e||it[e])&&r!==!1?(r="//"+(r||""),t&&t.charAt(0)!=="/"&&(t="/"+t)):r||(r=""),n&&n.charAt(0)!=="#"&&(n="#"+n),o&&o.charAt(0)!=="?"&&(o="?"+o),t=t.replace(/[?#]/g,function(a){return encodeURIComponent(a)}),o=o.replace("#","%23"),e+r+t+o+n};function uo(s,e){return yt(s,!1,!0).resolve(e)}me.prototype.resolve=function(s){return this.resolveObject(yt(s,!1,!0)).format()};function lo(s,e){return s?yt(s,!1,!0).resolveObject(e):e}me.prototype.resolveObject=function(s){if(Se.isString(s)){var e=new me;e.parse(s,!1,!0),s=e}for(var t=new me,n=Object.keys(this),r=0;r<n.length;r++){var u=n[r];t[u]=this[u]}if(t.hash=s.hash,s.href==="")return t.href=t.format(),t;if(s.slashes&&!s.protocol){for(var o=Object.keys(s),a=0;a<o.length;a++){var c=o[a];c!=="protocol"&&(t[c]=s[c])}return it[t.protocol]&&t.hostname&&!t.pathname&&(t.path=t.pathname="/"),t.href=t.format(),t}if(s.protocol&&s.protocol!==t.protocol){if(!it[s.protocol]){for(var d=Object.keys(s),p=0;p<d.length;p++){var b=d[p];t[b]=s[b]}return t.href=t.format(),t}if(t.protocol=s.protocol,!s.host&&!xs[s.protocol]){for(var w=(s.pathname||"").split("/");w.length&&!(s.host=w.shift()););s.host||(s.host=""),s.hostname||(s.hostname=""),w[0]!==""&&w.unshift(""),w.length<2&&w.unshift(""),t.pathname=w.join("/")}else t.pathname=s.pathname;if(t.search=s.search,t.query=s.query,t.host=s.host||"",t.auth=s.auth,t.hostname=s.hostname||s.host,t.port=s.port,t.pathname||t.search){var f=t.pathname||"",y=t.search||"";t.path=f+y}return t.slashes=t.slashes||s.slashes,t.href=t.format(),t}var x=t.pathname&&t.pathname.charAt(0)==="/",S=s.host||s.pathname&&s.pathname.charAt(0)==="/",h=S||x||t.host&&s.pathname,F=h,m=t.pathname&&t.pathname.split("/")||[],w=s.pathname&&s.pathname.split("/")||[],O=t.protocol&&!it[t.protocol];if(O&&(t.hostname="",t.port=null,t.host&&(m[0]===""?m[0]=t.host:m.unshift(t.host)),t.host="",s.protocol&&(s.hostname=null,s.port=null,s.host&&(w[0]===""?w[0]=s.host:w.unshift(s.host)),s.host=null),h=h&&(w[0]===""||m[0]==="")),S)t.host=s.host||s.host===""?s.host:t.host,t.hostname=s.hostname||s.hostname===""?s.hostname:t.hostname,t.search=s.search,t.query=s.query,m=w;else if(w.length)m||(m=[]),m.pop(),m=m.concat(w),t.search=s.search,t.query=s.query;else if(!Se.isNullOrUndefined(s.search)){if(O){t.hostname=t.host=m.shift();var P=t.host&&t.host.indexOf("@")>0?t.host.split("@"):!1;P&&(t.auth=P.shift(),t.host=t.hostname=P.shift())}return t.search=s.search,t.query=s.query,(!Se.isNull(t.pathname)||!Se.isNull(t.search))&&(t.path=(t.pathname?t.pathname:"")+(t.search?t.search:"")),t.href=t.format(),t}if(!m.length)return t.pathname=null,t.search?t.path="/"+t.search:t.path=null,t.href=t.format(),t;for(var k=m.slice(-1)[0],pe=(t.host||s.host||m.length>1)&&(k==="."||k==="..")||k==="",oe=0,K=m.length;K>=0;K--)k=m[K],k==="."?m.splice(K,1):k===".."?(m.splice(K,1),oe++):oe&&(m.splice(K,1),oe--);if(!h&&!F)for(;oe--;oe)m.unshift("..");h&&m[0]!==""&&(!m[0]||m[0].charAt(0)!=="/")&&m.unshift(""),pe&&m.join("/").substr(-1)!=="/"&&m.push("");var ve=m[0]===""||m[0]&&m[0].charAt(0)==="/";if(O){t.hostname=t.host=ve?"":m.length?m.shift():"";var P=t.host&&t.host.indexOf("@")>0?t.host.split("@"):!1;P&&(t.auth=P.shift(),t.host=t.hostname=P.shift())}return h=h||t.host&&m.length,h&&!ve&&m.unshift(""),m.length?t.pathname=m.join("/"):(t.pathname=null,t.path=null),(!Se.isNull(t.pathname)||!Se.isNull(t.search))&&(t.path=(t.pathname?t.pathname:"")+(t.search?t.search:"")),t.auth=s.auth||t.auth,t.slashes=t.slashes||s.slashes,t.href=t.format(),t};me.prototype.parseHost=function(){var s=this.host,e=eo.exec(s);e&&(e=e[0],e!==":"&&(this.port=e.substr(1)),s=s.substr(0,s.length-e.length)),s&&(this.hostname=s)}});var Ht=z(v=>{"use strict";Object.defineProperty(v,"__esModule",{value:!0});v.DebugSession=v.ErrorDestination=v.MemoryEvent=v.InvalidatedEvent=v.ProgressEndEvent=v.ProgressUpdateEvent=v.ProgressStartEvent=v.CapabilitiesEvent=v.LoadedSourceEvent=v.ModuleEvent=v.BreakpointEvent=v.ThreadEvent=v.OutputEvent=v.ExitedEvent=v.TerminatedEvent=v.InitializedEvent=v.ContinuedEvent=v.StoppedEvent=v.CompletionItem=v.Module=v.Breakpoint=v.Variable=v.Thread=v.StackFrame=v.Scope=v.Source=void 0;var co=An(),H=qt(),ho=xn(),Fn=_n(),Un=class{constructor(e,t,n=0,r,u){this.name=e,this.path=t,this.sourceReference=n,r&&(this.origin=r),u&&(this.adapterData=u)}};v.Source=Un;var Mn=class{constructor(e,t,n=!1){this.name=e,this.variablesReference=t,this.expensive=n}};v.Scope=Mn;var zn=class{constructor(e,t,n,r=0,u=0){this.id=e,this.source=n,this.line=r,this.column=u,this.name=t}};v.StackFrame=zn;var jn=class{constructor(e,t){this.id=e,t?this.name=t:this.name="Thread #"+e}};v.Thread=jn;var Wn=class{constructor(e,t,n=0,r,u){this.name=e,this.value=t,this.variablesReference=n,typeof u=="number"&&(this.namedVariables=u),typeof r=="number"&&(this.indexedVariables=r)}};v.Variable=Wn;var qn=class{constructor(e,t,n,r){this.verified=e;let u=this;typeof t=="number"&&(u.line=t),typeof n=="number"&&(u.column=n),r&&(u.source=r)}setId(e){this.id=e}};v.Breakpoint=qn;var Vn=class{constructor(e,t){this.id=e,this.name=t}};v.Module=Vn;var Gn=class{constructor(e,t,n=0){this.label=e,this.start=t,this.length=n}};v.CompletionItem=Gn;var Hn=class extends H.Event{constructor(e,t,n){super("stopped");this.body={reason:e},typeof t=="number"&&(this.body.threadId=t),typeof n=="string"&&(this.body.text=n)}};v.StoppedEvent=Hn;var Xn=class extends H.Event{constructor(e,t){super("continued");this.body={threadId:e},typeof t=="boolean"&&(this.body.allThreadsContinued=t)}};v.ContinuedEvent=Xn;var $n=class extends H.Event{constructor(){super("initialized")}};v.InitializedEvent=$n;var Jn=class extends H.Event{constructor(e){super("terminated");if(typeof e=="boolean"||e){let t=this;t.body={restart:e}}}};v.TerminatedEvent=Jn;var Kn=class extends H.Event{constructor(e){super("exited");this.body={exitCode:e}}};v.ExitedEvent=Kn;var Qn=class extends H.Event{constructor(e,t="console",n){super("output");this.body={category:t,output:e},n!==void 0&&(this.body.data=n)}};v.OutputEvent=Qn;var Zn=class extends H.Event{constructor(e,t){super("thread");this.body={reason:e,threadId:t}}};v.ThreadEvent=Zn;var Yn=class extends H.Event{constructor(e,t){super("breakpoint");this.body={reason:e,breakpoint:t}}};v.BreakpointEvent=Yn;var er=class extends H.Event{constructor(e,t){super("module");this.body={reason:e,module:t}}};v.ModuleEvent=er;var tr=class extends H.Event{constructor(e,t){super("loadedSource");this.body={reason:e,source:t}}};v.LoadedSourceEvent=tr;var sr=class extends H.Event{constructor(e){super("capabilities");this.body={capabilities:e}}};v.CapabilitiesEvent=sr;var nr=class extends H.Event{constructor(e,t,n){super("progressStart");this.body={progressId:e,title:t},typeof n=="string"&&(this.body.message=n)}};v.ProgressStartEvent=nr;var rr=class extends H.Event{constructor(e,t){super("progressUpdate");this.body={progressId:e},typeof t=="string"&&(this.body.message=t)}};v.ProgressUpdateEvent=rr;var ir=class extends H.Event{constructor(e,t){super("progressEnd");this.body={progressId:e},typeof t=="string"&&(this.body.message=t)}};v.ProgressEndEvent=ir;var or=class extends H.Event{constructor(e,t,n){super("invalidated");this.body={},e&&(this.body.areas=e),t&&(this.body.threadId=t),n&&(this.body.stackFrameId=n)}};v.InvalidatedEvent=or;var ar=class extends H.Event{constructor(e,t,n){super("memory");this.body={memoryReference:e,offset:t,count:n}}};v.MemoryEvent=ar;var Qe;(function(s){s[s.User=1]="User",s[s.Telemetry=2]="Telemetry"})(Qe=v.ErrorDestination||(v.ErrorDestination={}));var Ie=class extends co.ProtocolServer{constructor(e,t){super();let n=typeof e=="boolean"?e:!1;this._debuggerLinesStartAt1=n,this._debuggerColumnsStartAt1=n,this._debuggerPathsAreURIs=!1,this._clientLinesStartAt1=!0,this._clientColumnsStartAt1=!0,this._clientPathsAreURIs=!1,this._isServer=typeof t=="boolean"?t:!1,this.on("close",()=>{this.shutdown()}),this.on("error",r=>{this.shutdown()})}setDebuggerPathFormat(e){this._debuggerPathsAreURIs=e!=="path"}setDebuggerLinesStartAt1(e){this._debuggerLinesStartAt1=e}setDebuggerColumnsStartAt1(e){this._debuggerColumnsStartAt1=e}setRunAsServer(e){this._isServer=e}static run(e){(0,ho.runDebugAdapter)(e)}shutdown(){this._isServer||this._isRunningInline()||setTimeout(()=>{process.exit(0)},100)}sendErrorResponse(e,t,n,r,u=Qe.User){let o;typeof t=="number"?(o={id:t,format:n},r&&(o.variables=r),u&Qe.User&&(o.showUser=!0),u&Qe.Telemetry&&(o.sendTelemetry=!0)):o=t,e.success=!1,e.message=Ie.formatPII(o.format,!0,o.variables),e.body||(e.body={}),e.body.error=o,this.sendResponse(e)}runInTerminalRequest(e,t,n){this.sendRequest("runInTerminal",e,t,n)}dispatchRequest(e){let t=new H.Response(e);try{if(e.command==="initialize"){var n=e.arguments;if(typeof n.linesStartAt1=="boolean"&&(this._clientLinesStartAt1=n.linesStartAt1),typeof n.columnsStartAt1=="boolean"&&(this._clientColumnsStartAt1=n.columnsStartAt1),n.pathFormat!=="path")this.sendErrorResponse(t,2018,"debug adapter only supports native paths",null,Qe.Telemetry);else{let r=t;r.body={},this.initializeRequest(r,n)}}else e.command==="launch"?this.launchRequest(t,e.arguments,e):e.command==="attach"?this.attachRequest(t,e.arguments,e):e.command==="disconnect"?this.disconnectRequest(t,e.arguments,e):e.command==="terminate"?this.terminateRequest(t,e.arguments,e):e.command==="restart"?this.restartRequest(t,e.arguments,e):e.command==="setBreakpoints"?this.setBreakPointsRequest(t,e.arguments,e):e.command==="setFunctionBreakpoints"?this.setFunctionBreakPointsRequest(t,e.arguments,e):e.command==="setExceptionBreakpoints"?this.setExceptionBreakPointsRequest(t,e.arguments,e):e.command==="configurationDone"?this.configurationDoneRequest(t,e.arguments,e):e.command==="continue"?this.continueRequest(t,e.arguments,e):e.command==="next"?this.nextRequest(t,e.arguments,e):e.command==="stepIn"?this.stepInRequest(t,e.arguments,e):e.command==="stepOut"?this.stepOutRequest(t,e.arguments,e):e.command==="stepBack"?this.stepBackRequest(t,e.arguments,e):e.command==="reverseContinue"?this.reverseContinueRequest(t,e.arguments,e):e.command==="restartFrame"?this.restartFrameRequest(t,e.arguments,e):e.command==="goto"?this.gotoRequest(t,e.arguments,e):e.command==="pause"?this.pauseRequest(t,e.arguments,e):e.command==="stackTrace"?this.stackTraceRequest(t,e.arguments,e):e.command==="scopes"?this.scopesRequest(t,e.arguments,e):e.command==="variables"?this.variablesRequest(t,e.arguments,e):e.command==="setVariable"?this.setVariableRequest(t,e.arguments,e):e.command==="setExpression"?this.setExpressionRequest(t,e.arguments,e):e.command==="source"?this.sourceRequest(t,e.arguments,e):e.command==="threads"?this.threadsRequest(t,e):e.command==="terminateThreads"?this.terminateThreadsRequest(t,e.arguments,e):e.command==="evaluate"?this.evaluateRequest(t,e.arguments,e):e.command==="stepInTargets"?this.stepInTargetsRequest(t,e.arguments,e):e.command==="gotoTargets"?this.gotoTargetsRequest(t,e.arguments,e):e.command==="completions"?this.completionsRequest(t,e.arguments,e):e.command==="exceptionInfo"?this.exceptionInfoRequest(t,e.arguments,e):e.command==="loadedSources"?this.loadedSourcesRequest(t,e.arguments,e):e.command==="dataBreakpointInfo"?this.dataBreakpointInfoRequest(t,e.arguments,e):e.command==="setDataBreakpoints"?this.setDataBreakpointsRequest(t,e.arguments,e):e.command==="readMemory"?this.readMemoryRequest(t,e.arguments,e):e.command==="writeMemory"?this.writeMemoryRequest(t,e.arguments,e):e.command==="disassemble"?this.disassembleRequest(t,e.arguments,e):e.command==="cancel"?this.cancelRequest(t,e.arguments,e):e.command==="breakpointLocations"?this.breakpointLocationsRequest(t,e.arguments,e):e.command==="setInstructionBreakpoints"?this.setInstructionBreakpointsRequest(t,e.arguments,e):this.customRequest(e.command,t,e.arguments,e)}catch(r){this.sendErrorResponse(t,1104,"{_stack}",{_exception:r.message,_stack:r.stack},Qe.Telemetry)}}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,e.body.supportsRestartRequest=!1,e.body.supportsExceptionOptions=!1,e.body.supportsValueFormattingOptions=!1,e.body.supportsExceptionInfoRequest=!1,e.body.supportTerminateDebuggee=!1,e.body.supportsDelayedStackTraceLoading=!1,e.body.supportsLoadedSourcesRequest=!1,e.body.supportsLogPoints=!1,e.body.supportsTerminateThreadsRequest=!1,e.body.supportsSetExpression=!1,e.body.supportsTerminateRequest=!1,e.body.supportsDataBreakpoints=!1,e.body.supportsReadMemoryRequest=!1,e.body.supportsDisassembleRequest=!1,e.body.supportsCancelRequest=!1,e.body.supportsBreakpointLocationsRequest=!1,e.body.supportsClipboardContext=!1,e.body.supportsSteppingGranularity=!1,e.body.supportsInstructionBreakpoints=!1,e.body.supportsExceptionFilterOptions=!1,this.sendResponse(e)}disconnectRequest(e,t,n){this.sendResponse(e),this.shutdown()}launchRequest(e,t,n){this.sendResponse(e)}attachRequest(e,t,n){this.sendResponse(e)}terminateRequest(e,t,n){this.sendResponse(e)}restartRequest(e,t,n){this.sendResponse(e)}setBreakPointsRequest(e,t,n){this.sendResponse(e)}setFunctionBreakPointsRequest(e,t,n){this.sendResponse(e)}setExceptionBreakPointsRequest(e,t,n){this.sendResponse(e)}configurationDoneRequest(e,t,n){this.sendResponse(e)}continueRequest(e,t,n){this.sendResponse(e)}nextRequest(e,t,n){this.sendResponse(e)}stepInRequest(e,t,n){this.sendResponse(e)}stepOutRequest(e,t,n){this.sendResponse(e)}stepBackRequest(e,t,n){this.sendResponse(e)}reverseContinueRequest(e,t,n){this.sendResponse(e)}restartFrameRequest(e,t,n){this.sendResponse(e)}gotoRequest(e,t,n){this.sendResponse(e)}pauseRequest(e,t,n){this.sendResponse(e)}sourceRequest(e,t,n){this.sendResponse(e)}threadsRequest(e,t){this.sendResponse(e)}terminateThreadsRequest(e,t,n){this.sendResponse(e)}stackTraceRequest(e,t,n){this.sendResponse(e)}scopesRequest(e,t,n){this.sendResponse(e)}variablesRequest(e,t,n){this.sendResponse(e)}setVariableRequest(e,t,n){this.sendResponse(e)}setExpressionRequest(e,t,n){this.sendResponse(e)}evaluateRequest(e,t,n){this.sendResponse(e)}stepInTargetsRequest(e,t,n){this.sendResponse(e)}gotoTargetsRequest(e,t,n){this.sendResponse(e)}completionsRequest(e,t,n){this.sendResponse(e)}exceptionInfoRequest(e,t,n){this.sendResponse(e)}loadedSourcesRequest(e,t,n){this.sendResponse(e)}dataBreakpointInfoRequest(e,t,n){this.sendResponse(e)}setDataBreakpointsRequest(e,t,n){this.sendResponse(e)}readMemoryRequest(e,t,n){this.sendResponse(e)}writeMemoryRequest(e,t,n){this.sendResponse(e)}disassembleRequest(e,t,n){this.sendResponse(e)}cancelRequest(e,t,n){this.sendResponse(e)}breakpointLocationsRequest(e,t,n){this.sendResponse(e)}setInstructionBreakpointsRequest(e,t,n){this.sendResponse(e)}customRequest(e,t,n,r){this.sendErrorResponse(t,1014,"unrecognized request",null,Qe.Telemetry)}convertClientLineToDebugger(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e+1:this._clientLinesStartAt1?e-1:e}convertDebuggerLineToClient(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e-1:this._clientLinesStartAt1?e+1:e}convertClientColumnToDebugger(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e+1:this._clientColumnsStartAt1?e-1:e}convertDebuggerColumnToClient(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e-1:this._clientColumnsStartAt1?e+1:e}convertClientPathToDebugger(e){return this._clientPathsAreURIs!==this._debuggerPathsAreURIs?this._clientPathsAreURIs?Ie.uri2path(e):Ie.path2uri(e):e}convertDebuggerPathToClient(e){return this._debuggerPathsAreURIs!==this._clientPathsAreURIs?this._debuggerPathsAreURIs?Ie.uri2path(e):Ie.path2uri(e):e}static path2uri(e){process.platform==="win32"&&(/^[A-Z]:/.test(e)&&(e=e[0].toLowerCase()+e.substr(1)),e=e.replace(/\\/g,"/")),e=encodeURI(e);let t=new Fn.URL("file:");return t.pathname=e,t.toString()}static uri2path(e){let t=new Fn.URL(e),n=decodeURIComponent(t.pathname);return process.platform==="win32"&&(/^\/[a-zA-Z]:/.test(n)&&(n=n[1].toLowerCase()+n.substr(2)),n=n.replace(/\//g,"\\")),n}static formatPII(e,t,n){return e.replace(Ie._formatPIIRegexp,function(r,u){return t&&u.length>0&&u[0]!=="_"?r:n[u]&&n.hasOwnProperty(u)?n[u]:r})}};v.DebugSession=Ie;Ie._formatPIIRegexp=/{([^}]+)}/g});var lr=z(Xt=>{"use strict";Object.defineProperty(Xt,"__esModule",{value:!0});Xt.InternalLogger=void 0;var ur=class{dispose(){}log(e,t,n){}setup(e){}};Xt.InternalLogger=ur});var Is=z(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.trimLastNewline=ue.LogOutputEvent=ue.logger=ue.Logger=ue.LogLevel=void 0;var po=lr(),fo=Ht(),We;(function(s){s[s.Verbose=0]="Verbose",s[s.Log=1]="Log",s[s.Warn=2]="Warn",s[s.Error=3]="Error",s[s.Stop=4]="Stop"})(We=ue.LogLevel||(ue.LogLevel={}));var Ss=class{constructor(){this._pendingLogQ=[]}log(e,t=We.Log){e=e+`
`,this._write(e,t)}verbose(e){this.log(e,We.Verbose)}warn(e){this.log(e,We.Warn)}error(e){this.log(e,We.Error)}dispose(){if(this._currentLogger){let e=this._currentLogger.dispose();return this._currentLogger=null,e}else return Promise.resolve()}_write(e,t=We.Log){e=e+"",this._pendingLogQ?this._pendingLogQ.push({msg:e,level:t}):this._currentLogger&&this._currentLogger.log(e,t)}setup(e,t,n=!0){let r=typeof t=="string"?t:t&&this._logFilePathFromInit;if(this._currentLogger){let u={consoleMinLogLevel:e,logFilePath:r,prependTimestamp:n};this._currentLogger.setup(u).then(()=>{if(this._pendingLogQ){let o=this._pendingLogQ;this._pendingLogQ=null,o.forEach(a=>this._write(a.msg,a.level))}})}}init(e,t,n){this._pendingLogQ=this._pendingLogQ||[],this._currentLogger=new po.InternalLogger(e,n),this._logFilePathFromInit=t}};ue.Logger=Ss;ue.logger=new Ss;var cr=class extends fo.OutputEvent{constructor(e,t){let n=t===We.Error?"stderr":t===We.Warn?"console":"stdout";super(e,n)}};ue.LogOutputEvent=cr;function mo(s){return s.replace(/(\n|\r\n)$/,"")}ue.trimLastNewline=mo});var fr=z($t=>{"use strict";Object.defineProperty($t,"__esModule",{value:!0});$t.LoggingDebugSession=void 0;var dr=Is(),at=dr.logger,hr=Ht(),pr=class extends hr.DebugSession{constructor(e,t,n){super(t,n);this.obsolete_logFilePath=e,this.on("error",r=>{at.error(r.body)})}start(e,t){super.start(e,t),at.init(n=>this.sendEvent(n),this.obsolete_logFilePath,this._isServer)}sendEvent(e){if(!(e instanceof dr.LogOutputEvent)){let t=e;e instanceof hr.OutputEvent&&e.body&&e.body.data&&e.body.data.doNotLogOutput&&(delete e.body.data.doNotLogOutput,t={...e},t.body={...e.body,output:"<output not logged>"}),at.verbose(`To client: ${JSON.stringify(t)}`)}super.sendEvent(e)}sendRequest(e,t,n,r){at.verbose(`To client: ${JSON.stringify(e)}(${JSON.stringify(t)}), timeout: ${n}`),super.sendRequest(e,t,n,r)}sendResponse(e){at.verbose(`To client: ${JSON.stringify(e)}`),super.sendResponse(e)}dispatchRequest(e){at.verbose(`From client: ${e.command}(${JSON.stringify(e.arguments)})`),super.dispatchRequest(e)}};$t.LoggingDebugSession=pr});var gr=z(Jt=>{"use strict";Object.defineProperty(Jt,"__esModule",{value:!0});Jt.Handles=void 0;var mr=class{constructor(e){this.START_HANDLE=1e3,this._handleMap=new Map,this._nextHandle=typeof e=="number"?e:this.START_HANDLE}reset(){this._nextHandle=this.START_HANDLE,this._handleMap=new Map}create(e){var t=this._nextHandle++;return this._handleMap.set(t,e),t}get(e,t){return this._handleMap.get(e)||t}};Jt.Handles=mr});var yr=z(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.Handles=g.Response=g.Event=g.ErrorDestination=g.CompletionItem=g.Module=g.Source=g.Breakpoint=g.Variable=g.Scope=g.StackFrame=g.Thread=g.MemoryEvent=g.InvalidatedEvent=g.ProgressEndEvent=g.ProgressUpdateEvent=g.ProgressStartEvent=g.CapabilitiesEvent=g.LoadedSourceEvent=g.ModuleEvent=g.BreakpointEvent=g.ThreadEvent=g.OutputEvent=g.ContinuedEvent=g.StoppedEvent=g.ExitedEvent=g.TerminatedEvent=g.InitializedEvent=g.logger=g.Logger=g.LoggingDebugSession=g.DebugSession=void 0;var B=Ht();Object.defineProperty(g,"DebugSession",{enumerable:!0,get:function(){return B.DebugSession}});Object.defineProperty(g,"InitializedEvent",{enumerable:!0,get:function(){return B.InitializedEvent}});Object.defineProperty(g,"TerminatedEvent",{enumerable:!0,get:function(){return B.TerminatedEvent}});Object.defineProperty(g,"ExitedEvent",{enumerable:!0,get:function(){return B.ExitedEvent}});Object.defineProperty(g,"StoppedEvent",{enumerable:!0,get:function(){return B.StoppedEvent}});Object.defineProperty(g,"ContinuedEvent",{enumerable:!0,get:function(){return B.ContinuedEvent}});Object.defineProperty(g,"OutputEvent",{enumerable:!0,get:function(){return B.OutputEvent}});Object.defineProperty(g,"ThreadEvent",{enumerable:!0,get:function(){return B.ThreadEvent}});Object.defineProperty(g,"BreakpointEvent",{enumerable:!0,get:function(){return B.BreakpointEvent}});Object.defineProperty(g,"ModuleEvent",{enumerable:!0,get:function(){return B.ModuleEvent}});Object.defineProperty(g,"LoadedSourceEvent",{enumerable:!0,get:function(){return B.LoadedSourceEvent}});Object.defineProperty(g,"CapabilitiesEvent",{enumerable:!0,get:function(){return B.CapabilitiesEvent}});Object.defineProperty(g,"ProgressStartEvent",{enumerable:!0,get:function(){return B.ProgressStartEvent}});Object.defineProperty(g,"ProgressUpdateEvent",{enumerable:!0,get:function(){return B.ProgressUpdateEvent}});Object.defineProperty(g,"ProgressEndEvent",{enumerable:!0,get:function(){return B.ProgressEndEvent}});Object.defineProperty(g,"InvalidatedEvent",{enumerable:!0,get:function(){return B.InvalidatedEvent}});Object.defineProperty(g,"MemoryEvent",{enumerable:!0,get:function(){return B.MemoryEvent}});Object.defineProperty(g,"Thread",{enumerable:!0,get:function(){return B.Thread}});Object.defineProperty(g,"StackFrame",{enumerable:!0,get:function(){return B.StackFrame}});Object.defineProperty(g,"Scope",{enumerable:!0,get:function(){return B.Scope}});Object.defineProperty(g,"Variable",{enumerable:!0,get:function(){return B.Variable}});Object.defineProperty(g,"Breakpoint",{enumerable:!0,get:function(){return B.Breakpoint}});Object.defineProperty(g,"Source",{enumerable:!0,get:function(){return B.Source}});Object.defineProperty(g,"Module",{enumerable:!0,get:function(){return B.Module}});Object.defineProperty(g,"CompletionItem",{enumerable:!0,get:function(){return B.CompletionItem}});Object.defineProperty(g,"ErrorDestination",{enumerable:!0,get:function(){return B.ErrorDestination}});var go=fr();Object.defineProperty(g,"LoggingDebugSession",{enumerable:!0,get:function(){return go.LoggingDebugSession}});var br=Is();g.Logger=br;var vr=qt();Object.defineProperty(g,"Event",{enumerable:!0,get:function(){return vr.Event}});Object.defineProperty(g,"Response",{enumerable:!0,get:function(){return vr.Response}});var bo=gr();Object.defineProperty(g,"Handles",{enumerable:!0,get:function(){return bo.Handles}});var vo=br.logger;g.logger=vo});var wr=z((Jo,Dr)=>{"use strict";function Le(s){if(typeof s!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(s))}function Rr(s,e){for(var t="",n=0,r=-1,u=0,o,a=0;a<=s.length;++a){if(a<s.length)o=s.charCodeAt(a);else{if(o===47)break;o=47}if(o===47){if(!(r===a-1||u===1))if(r!==a-1&&u===2){if(t.length<2||n!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){var c=t.lastIndexOf("/");if(c!==t.length-1){c===-1?(t="",n=0):(t=t.slice(0,c),n=t.length-1-t.lastIndexOf("/")),r=a,u=0;continue}}else if(t.length===2||t.length===1){t="",n=0,r=a,u=0;continue}}e&&(t.length>0?t+="/..":t="..",n=2)}else t.length>0?t+="/"+s.slice(r+1,a):t=s.slice(r+1,a),n=a-r-1;r=a,u=0}else o===46&&u!==-1?++u:u=-1}return t}function yo(s,e){var t=e.dir||e.root,n=e.base||(e.name||"")+(e.ext||"");return t?t===e.root?t+n:t+s+n:n}var ut={resolve:function(){for(var e="",t=!1,n,r=arguments.length-1;r>=-1&&!t;r--){var u;r>=0?u=arguments[r]:(n===void 0&&(n=process.cwd()),u=n),Le(u),u.length!==0&&(e=u+"/"+e,t=u.charCodeAt(0)===47)}return e=Rr(e,!t),t?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(Le(e),e.length===0)return".";var t=e.charCodeAt(0)===47,n=e.charCodeAt(e.length-1)===47;return e=Rr(e,!t),e.length===0&&!t&&(e="."),e.length>0&&n&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return Le(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var n=arguments[t];Le(n),n.length>0&&(e===void 0?e=n:e+="/"+n)}return e===void 0?".":ut.normalize(e)},relative:function(e,t){if(Le(e),Le(t),e===t||(e=ut.resolve(e),t=ut.resolve(t),e===t))return"";for(var n=1;n<e.length&&e.charCodeAt(n)===47;++n);for(var r=e.length,u=r-n,o=1;o<t.length&&t.charCodeAt(o)===47;++o);for(var a=t.length,c=a-o,d=u<c?u:c,p=-1,b=0;b<=d;++b){if(b===d){if(c>d){if(t.charCodeAt(o+b)===47)return t.slice(o+b+1);if(b===0)return t.slice(o+b)}else u>d&&(e.charCodeAt(n+b)===47?p=b:b===0&&(p=0));break}var f=e.charCodeAt(n+b),y=t.charCodeAt(o+b);if(f!==y)break;f===47&&(p=b)}var x="";for(b=n+p+1;b<=r;++b)(b===r||e.charCodeAt(b)===47)&&(x.length===0?x+="..":x+="/..");return x.length>0?x+t.slice(o+p):(o+=p,t.charCodeAt(o)===47&&++o,t.slice(o))},_makeLong:function(e){return e},dirname:function(e){if(Le(e),e.length===0)return".";for(var t=e.charCodeAt(0),n=t===47,r=-1,u=!0,o=e.length-1;o>=1;--o)if(t=e.charCodeAt(o),t===47){if(!u){r=o;break}}else u=!1;return r===-1?n?"/":".":n&&r===1?"//":e.slice(0,r)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');Le(e);var n=0,r=-1,u=!0,o;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var a=t.length-1,c=-1;for(o=e.length-1;o>=0;--o){var d=e.charCodeAt(o);if(d===47){if(!u){n=o+1;break}}else c===-1&&(u=!1,c=o+1),a>=0&&(d===t.charCodeAt(a)?--a===-1&&(r=o):(a=-1,r=c))}return n===r?r=c:r===-1&&(r=e.length),e.slice(n,r)}else{for(o=e.length-1;o>=0;--o)if(e.charCodeAt(o)===47){if(!u){n=o+1;break}}else r===-1&&(u=!1,r=o+1);return r===-1?"":e.slice(n,r)}},extname:function(e){Le(e);for(var t=-1,n=0,r=-1,u=!0,o=0,a=e.length-1;a>=0;--a){var c=e.charCodeAt(a);if(c===47){if(!u){n=a+1;break}continue}r===-1&&(u=!1,r=a+1),c===46?t===-1?t=a:o!==1&&(o=1):t!==-1&&(o=-1)}return t===-1||r===-1||o===0||o===1&&t===r-1&&t===n+1?"":e.slice(t,r)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return yo("/",e)},parse:function(e){Le(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var n=e.charCodeAt(0),r=n===47,u;r?(t.root="/",u=1):u=0;for(var o=-1,a=0,c=-1,d=!0,p=e.length-1,b=0;p>=u;--p){if(n=e.charCodeAt(p),n===47){if(!d){a=p+1;break}continue}c===-1&&(d=!1,c=p+1),n===46?o===-1?o=p:b!==1&&(b=1):o!==-1&&(b=-1)}return o===-1||c===-1||b===0||b===1&&o===c-1&&o===a+1?c!==-1&&(a===0&&r?t.base=t.name=e.slice(1,c):t.base=t.name=e.slice(a,c)):(a===0&&r?(t.name=e.slice(1,o),t.base=e.slice(1,c)):(t.name=e.slice(a,o),t.base=e.slice(a,c)),t.ext=e.slice(o,c)),a>0?t.dir=e.slice(0,a-1):r&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};ut.posix=ut;Dr.exports=ut});var Di=z(ps=>{"use strict";(function(s){var e=function(u,o){return new t(u,o).toString()},t=function(u,o){let a=this,c=8;switch(typeof Buffer<"u"&&(u=Buffer.isBuffer(u)&&u||typeof u=="string"&&Buffer.from(u)||u&&u.constructor===Array&&Buffer.from(u)||Buffer.alloc(0)),u=u||[],o=o||{},a.buffer=u,a.bytes_per_line=parseInt(o.width)||16,a.numbering=o.numbering=="none"?"none":"hex_bytes",a.bytes_per_group=2,o.format){case"none":a.bytes_per_group=0;break;case"twos":a.bytes_per_group=1;break;case"eights":a.bytes_per_group=4;break;case"sixteens":a.bytes_per_group=8;break}switch(a.littleEndian=o.littleEndian||!1,a.radix=o.radix||16,a.caps=o.caps=="upper"?"upper":"lower",a.annotate=o.annotate=="none"?"none":"ascii",a.prefix=o.prefix||"",a.indent=o.indent||0,a.html=o.html||!1,a.offset=o.offset||0,a.length=o.length||-1,a.extendedChs=o.extendedChs||!1,a.display_offset=o.display_offset||0,a.offset&&a.offset<a.buffer.length&&(a.buffer=a.buffer.slice(a.offset)),a.length!==-1&&a.length<=a.buffer.length&&(a.buffer=a.buffer.slice(0,a.length)),a.prefix=(a.html?"&nbsp;":" ").repeat(a.indent)+a.prefix,a.hex_line_length=n(a.bytes_per_group,a.radix)*a.bytes_per_line/Math.max(a.bytes_per_group,1),a.bytes_per_group){case 8:case 4:case 2:a.hex_line_length+=Math.floor(a.bytes_per_line/a.bytes_per_group);break;case 1:a.hex_line_length+=a.bytes_per_line+3;break;case 0:a.hex_line_length+=2;break}a.bytes_per_group=Math.min(a.bytes_per_group,a.bytes_per_line),this.toString=function(){var h="",F=a.offset+a.display_offset,m=!1;a.html&&(h+=`<div class='hexy'>
`);for(var w=0;w<a.buffer.length;w+=a.bytes_per_line){let P=Math.min(w+a.bytes_per_line,a.buffer.length),k=a.buffer.slice(w,P);if(a.html&&(h+="<div class='"+p(F,c,16)+(m?"  odd":" even")+"'>",m=!m),h+=a.prefix,a.numbering==="hex_bytes"&&(h+=p(F,c,16)+": "),h+=d(k,a.bytes_per_line,a.bytes_per_group,a.radix,a.littleEndian),a.annotate==="ascii"){var O="";switch(k.constructor){case Array:O=String.fromCharCode.apply(a,k);break;case Uint8Array:k.forEach(pe=>O+=String.fromCharCode(pe));break;default:O=k.toString("latin1")}h+=" "+(a.html?S(O):x(O))}h+=a.html?`</div>
`:`
`,F+=a.bytes_per_line}return a.html&&(h+=`</div>
`),h};var d=function(h,F,m,w,O){var P="";let k=m==0?"":" ",pe=n(m,w),oe=(F-h.length)*(m==0?pe:(pe+1)/m);m==0&&(m=1);let K=O?m-1:0,ve=O?-1:m,Je=O?-1:1;for(var Ue=0;Ue<h.length/m;++Ue){for(var te=m<4?0:BigInt(0),xe=K;xe!=ve;xe+=Je){let Te=Ue*m+xe;if(Te>=h.length)break;m<4?te=te*256+((h.constructor==String?h.codePointAt(Te):h[Te])&255):te=BigInt(te)*256n+BigInt((h.constructor==String?h.codePointAt(Te):h[Te])&255)}let Be=te.toString(w);for(var Oe=0;Oe<pe-Be.length;Oe++)P+="0";P+=Be,P+=k,a.caps==="upper"&&(P=P.toUpperCase())}return h.length<F&&(P+=(a.html?"&nbsp;":" ").repeat(oe)),P=b(P,a.hex_line_length),P},p=function(h,F,m){let w=h.toString(m);return"0".repeat(F-w.length)+w},b=function(h,F){let m=F-h.length-1;return m>0&&(h+=(a.html?"&nbsp;":" ").repeat(m)),h};let f=/[^\x20-\x7f]/g,y=/[\x00-\x1f]/g;var x=function(h){return h.replace(a.extendedChs?y:f,".")},S=function(h){return h=h.replace(/&/g,"&amp;"),h=h.replace(/</g,"&lt;"),h=h.replace(/>/g,"&gt;"),a.extendedChs?(h=h.replace(/\'/g,"&apos;"),h=h.replace(/\"/g,"&quot;"),h=h.replace(f,function(F){return F=F.codePointAt(0),"&#x"+F.toString(16)+";"})):h=h.replace(f,"."),h}};t.VERSION="0.3.4";var n=function(u,o){var a=2;switch(u==0&&(u=1),o){case 2:a=u*8;break;case 8:switch(u){case 1:a=3;break;case 2:a=6;break;case 4:a=11;break;case 8:a=22;break}break;case 10:switch(u){case 1:a=3;break;case 2:a=6;break;case 4:a=10;break;case 8:a=20;break}break;case 16:a=2*u;break}return a},r;typeof ps<"u"?r=ps:s===window?r=window:r=s,r.hexy=e,r.Hexy=t,r.maxnumberlen=n})(ps)});var Si=z(Ei=>{function gs(){this.waiters=[]}gs.prototype.wait=function(s){var e=this,t={};this.waiters.push(t);var n=new Promise(function(r){var u=!1;t.resolve=function(o){if(!u){if(u=!0,t.timeout&&(clearTimeout(t.timeout),t.timeout=null),!o){var a=e.waiters.indexOf(t);a>-1&&e.waiters.splice(a,1)}r()}}});return s>0&&isFinite(s)&&(t.timeout=setTimeout(function(){t.timeout=null,t.resolve()},s)),n};gs.prototype.notify=function(){this.waiters.length>0&&this.waiters.pop().resolve(!0)};gs.prototype.notifyAll=function(){for(var s=this.waiters.length-1;s>=0;s--)this.waiters[s].resolve(!0);this.waiters=[]};Ei.Subject=gs});var Pi=z(bs=>{"use strict";bs.byteLength=Ao;bs.toByteArray=Eo;bs.fromByteArray=Lo;var ke=[],be=[],wo=typeof Uint8Array<"u"?Uint8Array:Array,un="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(et=0,Ii=un.length;et<Ii;++et)ke[et]=un[et],be[un.charCodeAt(et)]=et;var et,Ii;be["-".charCodeAt(0)]=62;be["_".charCodeAt(0)]=63;function Li(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function Ao(s){var e=Li(s),t=e[0],n=e[1];return(t+n)*3/4-n}function xo(s,e,t){return(e+t)*3/4-t}function Eo(s){var e,t=Li(s),n=t[0],r=t[1],u=new wo(xo(s,n,r)),o=0,a=r>0?n-4:n,c;for(c=0;c<a;c+=4)e=be[s.charCodeAt(c)]<<18|be[s.charCodeAt(c+1)]<<12|be[s.charCodeAt(c+2)]<<6|be[s.charCodeAt(c+3)],u[o++]=e>>16&255,u[o++]=e>>8&255,u[o++]=e&255;return r===2&&(e=be[s.charCodeAt(c)]<<2|be[s.charCodeAt(c+1)]>>4,u[o++]=e&255),r===1&&(e=be[s.charCodeAt(c)]<<10|be[s.charCodeAt(c+1)]<<4|be[s.charCodeAt(c+2)]>>2,u[o++]=e>>8&255,u[o++]=e&255),u}function So(s){return ke[s>>18&63]+ke[s>>12&63]+ke[s>>6&63]+ke[s&63]}function Io(s,e,t){for(var n,r=[],u=e;u<t;u+=3)n=(s[u]<<16&16711680)+(s[u+1]<<8&65280)+(s[u+2]&255),r.push(So(n));return r.join("")}function Lo(s){for(var e,t=s.length,n=t%3,r=[],u=16383,o=0,a=t-n;o<a;o+=u)r.push(Io(s,o,o+u>a?a:o+u));return n===1?(e=s[t-1],r.push(ke[e>>2]+ke[e<<4&63]+"==")):n===2&&(e=(s[t-2]<<8)+s[t-1],r.push(ke[e>>10]+ke[e>>4&63]+ke[e<<2&63]+"=")),r.join("")}});var Oo={};ji(Oo,{activate:()=>Co,deactivate:()=>ko});module.exports=Wi(Oo);var L=ze(require("vscode"));var D=ze(yr()),Ci=ze(wr());var Ai=ze(ws());var se=(u=>(u[u.UNKNOWN=0]="UNKNOWN",u[u.DB=1]="DB",u[u.DW=2]="DW",u[u.DD=4]="DD",u[u.DQ=8]="DQ",u))(se||{});function*Ro(){let s=0;for(;;)yield++s}var Do=Ro(),Ar=()=>Do.next().value??-1;var qe=class{constructor(e=1,t=1){this.line=e;this.column=t}};var Rt=(h=>(h[h.NUMBER=0]="NUMBER",h[h.IDENTIFIER=1]="IDENTIFIER",h[h.STRING=2]="STRING",h[h.COMMENT=3]="COMMENT",h[h.LPAREN=4]="LPAREN",h[h.RPAREN=5]="RPAREN",h[h.LSQUARE=6]="LSQUARE",h[h.RSQUARE=7]="RSQUARE",h[h.COMMA=8]="COMMA",h[h.COLON=9]="COLON",h[h.QMARK=10]="QMARK",h[h.PLUS=11]="PLUS",h[h.MINUS=12]="MINUS",h[h.END=13]="END",h[h.UNKNOWN=14]="UNKNOWN",h[h.NEWLINE=15]="NEWLINE",h))(Rt||{}),j=class{constructor(e,t,n=new qe){this.type=e;this.lexeme=t;this.pos=n;this.id=Ar()}toString(){return`|${this.id}|${Rt[this.type]}|${this.lexeme}|Line ${this.pos.line} Column ${this.pos.column}|`}};var le=class extends Error{constructor(e,t){super(`Encountered error at line ${t.pos.line} column ${t.pos.column}: ${e}`);this.message=e;this.token=t}},De=class extends le{constructor(e){super(`Invalid token "${e.lexeme}"`,e)}},Ls=class extends le{constructor(e){super(`Invalid immediate "${e.lexeme}"`,e)}},Ps=class extends le{constructor(e){super(`Invalid register "${e.lexeme}"`,e)}},lt=class extends le{constructor(e,t,n){super(`Invalid instruction "${e.lexeme}${t?` ${[t?.lexeme,n?.lexeme].join(", ")}`:""}"`,e);this.op1=t;this.op2=n}};var ct=class extends le{constructor(e){super(`Invalid label "${e.lexeme}"`,e)}},Cs=class extends le{constructor(e){super(`Invalid data ${e.lexeme}`,e)}},ks=class extends le{constructor(e){super(`Invalid segment ${e.lexeme}`,e)}},Os=class extends le{constructor(e){super(`Invalid procedure ${e.lexeme}`,e)}};var Bs=class extends le{constructor(e){super("Unterminated quote",e)}},Ts=class extends le{constructor(e){super("Unterminated bracket",e)}},Ns=class extends le{constructor(e){super("Unterminated segment",e)}},_s=class extends le{constructor(e){super("Unterminated procedure",e)}};function _e(s){if(!/^-?(([0-9]+|[0-9a-f]+h)|[10]+b)$/i.test(s))return null;let e=NaN;return/^-?[01]+b$/i.test(s)?e=parseInt(s,2):/^-?[0-9][0-9a-f]*h$/i.test(s)?e=parseInt(s,16):e=parseInt(s),Number.isNaN(e)?null:{value:e,size:ht(e)}}function ht(s){let e=s<0;e&&(s*=-1);let t=Math.ceil(Math.log2(e?s:s+1)),n=Object.entries(se).filter(([u,o])=>isNaN(Number(u))&&o).map(([u,o])=>[u,Number(o)*8]),r=null;for(let[u,o]of n)if(t<=(e?o-1:o)){r=se[u];break}if(!r)throw Error(`Value ${s} is too large, max ${n[n.length-1][1]} bits are allowed`);return r}function Fe(s){let e=0;for(;s!==0;)e+=s&1,s>>=1;return e}function dt(s,e){return new(e===1?Uint8Array:Uint16Array)([s])[0]}function xr(s,e){let t=new DataView(new(e===1?Uint8Array:Uint16Array)([s]).buffer);return e===1?t.getInt8(0):t.getInt16(0,!0)}function Z(s,e){return s&(e===1?128:e===2?32768:e===4?2147483648:9223372036854776e3)}var Er=function(s){this.op1.setValue(s,this.op2.getValue(s))},Sr=function(s){this.op1.setValue(s,this.op2.getValue(s))},Ir=function(s){this.op1.setValue(s,this.op2.getValue(s))},W=function(s){this.op1.setValue(s,this.op2.getValue(s))},pt=function(s){this.op1.setValue(s,this.op2.getValue(s)),this.op2.setValue(s,this.op1.getValue(s))},Lr=function(s){},Y=function(s,e=!1,t,n){let r=this.op1.size||this.op2.size,[u,o]=this.getSigned(s);if(u=t??u,o=n??o,u===void 0||o===void 0)throw new lt(this.token,this.op1.token,this.op2.token);let a=dt(u+o+(e?s.registers.FLAG.carry:0),r),c=u<0?1:0,d=o<0?1:0,p=Z(a,r)?1:0;s.registers.FLAG.zero=a===0?1:0,s.registers.FLAG.sign=p?1:0,s.registers.FLAG.auxilliary=(u&15)+(o&15)+s.registers.FLAG.carry>15?1:0,s.registers.FLAG.carry=ht(u+o+(e?s.registers.FLAG.carry:0))>r?1:0,s.registers.FLAG.overflow=c===d&&c!==p?1:0,s.registers.FLAG.parity=Fe(a&255)%2===0?1:0,this.op1.setValue(s,a)},ce=function(s){Y.call(this,s,!0)},ne=function(s,e=!0){let t=this.op1.size||this.op2.size,[n,r]=this.getUnsigned(s);if(n===void 0||r===void 0)return;let u=dt(n&r,t);s.registers.FLAG.carry=0,s.registers.FLAG.overflow=0,s.registers.FLAG.zero=u===0?1:0,s.registers.FLAG.sign=Z(u,t),s.registers.FLAG.parity=Fe(u&255)%2===0?1:0,e&&this.op1.setValue(s,u)},re=function(s,e=!0,t=!1,n,r){let u=this.op1.size||this.op2.size,[o,a]=this.getSigned(s);if(o=n??o,a=r??a,o===void 0||a===void 0)throw new lt(this.token,this.op1.token,this.op2.token);let c=dt(o-a-(t?s.registers.FLAG.carry:0),u),d=o<0?1:0,p=a<0?1:0,b=Z(c,u)?1:0;s.registers.FLAG.zero=c===0?1:0,s.registers.FLAG.sign=b?1:0,s.registers.FLAG.auxilliary=(a&15)>(o&15)?1:0,s.registers.FLAG.carry=a>o?1:0,s.registers.FLAG.overflow=d!==p&&d!==b?1:0,s.registers.FLAG.parity=Fe(c&255)%2===0?1:0,e&&this.op1.setValue(s,c)},he=function(s){re.call(this,s,!1)},Kt=function(s){re.call(this,s,!0,!1,null,1)},Dt=function(s,e=!1){let{size:t}=this.op1,n=e?xr(this.op1.getValue(s),t):dt(this.op1.getValue(s),t);if(n===0){tn.call(this,s,0);return}let r=e?s.registers.AX.signed:s.registers.AX.value,u=e?s.registers.DX.signed:s.registers.DX.value;if(t===1){let a=r/n;s.registers.AL.value=a<0?Math.ceil(a):Math.floor(a),s.registers.AH.value=r%n}else{let a=u<<16|r;s.registers.AX.value=Math.floor(a/n),s.registers.DX.value=a%n}let o=t===1?s.registers.AL.value:s.registers.AX.value;s.registers.FLAG.zero=o===0?1:0,s.registers.FLAG.parity=Fe(o&255)%2===0?1:0,e&&(s.registers.FLAG.sign=o&(t===1?128:32768)?1:0,s.registers.FLAG.carry=ht(o)>t?1:0,s.registers.FLAG.overflow=ht(o)>t?1:0)},Qt=function(s){Dt.call(this,s,!0)},wt=function(s,e=!1){let{size:t}=this.op1,n=e?xr(this.op1.getValue(s),t):dt(this.op1.getValue(s),t),r=e?s.registers.AL.signed:s.registers.AL.value,u=e?s.registers.AX.signed:s.registers.AX.value;t===1?s.registers.AX.value=r*n:(s.registers.AX.value=u*n&65535,s.registers.DX.value=u*n&4294901760);let o=t===1?s.registers.AX.value:s.registers.DX.value<<16|s.registers.AX.value;s.registers.FLAG.zero=o===0?1:0,s.registers.FLAG.parity=Fe(o&255)%2===0?1:0,s.registers.FLAG.carry=ht(o)>t*2?1:0,e&&(s.registers.FLAG.sign=o&(t===1?128:32768)?1:0,s.registers.FLAG.overflow=Z(o,t*2)!==Z(t===1?s.registers.AL.value:s.registers.AX.value,t)?1:0)},Zt=function(s){wt.call(this,s,!0)},Yt=function(s){Y.call(this,s,!1,null,1)},es=function(s){let e=this.op1.getValue(s);s.registers.FLAG.carry=e!==0?1:0,s.registers.FLAG.zero=e===0?1:0,s.registers.FLAG.sign=Z(e,this.op1.size)?0:1,s.registers.FLAG.parity=Fe(e&255)%2===0?1:0,this.op1.setValue(s,-1*e)},ts=function(s){this.op1.setValue(s,~this.op1.getValue(s))},de=function(s){let e=this.op1.size||this.op2.size,[t,n]=this.getUnsigned(s);if(t===void 0||n===void 0)return;let r=dt(t|n,e);s.registers.FLAG.zero=r===0?1:0,s.registers.FLAG.sign=Z(r,e)?1:0,s.registers.FLAG.parity=Fe(r&255)%2===0?1:0,this.op1.setValue(s,r)},Ve=function(s,e=!1,t=!1){let n=this.op1.getValue(s),r=this.op2.getValue(s),u,o=s.registers.FLAG.carry;for(let a=0;a<r;a++){let c=o;o=Z(n,this.op1.size)?1:0,u=(t?n>>1:n<<1)&(this.op1.size===1?255:65535)|(e?c:o)}s.registers.FLAG.carry=o,this.op1.setValue(s,u)},At=function(s){Ve.call(this,s,!0)},xt=function(s){Ve.call(this,s,!0,!0)},Et=function(s){Ve.call(this,s,!1,!0)},Ge=function(s,e=!1,t=!0){let n=this.op1.getValue(s),r=this.op2.getValue(s),u,o;for(let a=0;a<r;a++)u=(e?n>>1:n<<1)&(this.op1.size===1?255:65535),e&&t&&(o=Z(n,this.op1.size)?1:0,u|=this.op1.size===1?o<<7:o<<15);s.registers.FLAG.zero=u===0?1:0,s.registers.FLAG.sign=Z(u,this.op1.size)?1:0,s.registers.FLAG.carry=o,s.registers.FLAG.auxilliary=r===1?1:0,s.registers.FLAG.overflow=Z(n,this.op1.size)!==Z(u,this.op1.size)?1:0,this.op1.setValue(s,u)},St=function(s){Ge.call(this,s,!0)},It=Ge,Lt=function(s){Ge.call(this,s,!0,!1)},ee=function(s){re.call(this,s,!0,!0)},we=function(s){ne.call(this,s,!1)},ie=function(s){let e=this.op1.getValue(s)^this.op2.getValue(s);s.registers.FLAG.overflow=0,s.registers.FLAG.carry=0,s.registers.FLAG.zero=e===0?1:0,s.registers.FLAG.sign=Z(e,this.op1.size)?1:0,s.registers.FLAG.parity=Fe(e&255)%2===0?1:0,s.registers.FLAG.auxilliary=e&4?1:0,this.op1.setValue(s,e)},T=function(s){if(!this.farptr)this.op1 instanceof N?s.registers.IP.value+=this.op1.getDisp(s)-this.size(s):s.registers.IP.value=this.op1.getSigned(s)-this.size(s);else if(this.op1 instanceof U){let e=this.op1.getAddress(s);s.registers.IP.value=s.memory.get(e,2)-this.size(s),s.registers.CS.value=s.memory.get(e+2,2)}else if(this.op1 instanceof He)s.registers.IP.value=this.op1.offset.getUnsigned(s)-this.size(s),s.registers.CS.value=this.op1.segment.getUnsigned(s);else if(this.op1 instanceof N){let e=this.op1.getNode(s);if(e instanceof Xe){if(!e.location)return;let t=e.getSegment(s),n=e.location-t;s.registers.IP.value=n-this.size(s),s.registers.CS.value=t>>4}}},ft=function(s){if(this.op1 instanceof N){let e=this.op1.getNode(s);e instanceof Xe&&(this.farptr=!e.near)}else this.op1 instanceof He&&(this.farptr=!0);this.farptr&&s.push(s.registers.CS.value),s.push(s.registers.IP.value+this.size(s)),T.call(this,s)},ss=function(s,e=!1){if(s.registers.IP.value=s.pop()-this.size(s),e&&(s.registers.CS.value=s.pop()),this.op1){let t=this.op1.getValue(s);for(let n=0;n<t;n++)s.pop()}},Fs=function(s){ss.call(this,s,!0)},ns=function(s,e=!0){s.registers.CX.value--,s.registers.CX.value!==0&&e&&(s.registers.IP.value+=this.op1.getDisp(s)-this.size(s))},Us=function(s){ns.call(this,s,s.registers.FLAG.zero)},Ms=function(s){ns.call(this,s,!s.registers.FLAG.zero)},Pr=Ms,Cr=Us,zs=function(s){s.registers.FLAG.carry===0&&s.registers.FLAG.zero===0&&T.call(this,s)},rs=function(s){s.registers.FLAG.carry===0&&T.call(this,s)},is=function(s){s.registers.FLAG.carry===1&&T.call(this,s)},kr=is,js=function(s){(s.registers.FLAG.carry===1||s.registers.FLAG.zero===1)&&T.call(this,s)},Or=function(s){s.registers.CX.value===0&&T.call(this,s)},Ws=function(s){s.registers.FLAG.zero===1&&T.call(this,s)},qs=function(s){s.registers.FLAG.zero===0&&s.registers.FLAG.sign===s.registers.FLAG.overflow&&T.call(this,s)},Vs=function(s){s.registers.FLAG.sign===s.registers.FLAG.overflow&&T.call(this,s)},Gs=function(s){s.registers.FLAG.sign!==s.registers.FLAG.overflow&&s.registers.FLAG.zero===0&&T.call(this,s)},Hs=function(s){(s.registers.FLAG.zero===1||s.registers.FLAG.sign!==s.registers.FLAG.overflow)&&T.call(this,s)},Br=js,Tr=is,Nr=rs,_r=rs,Fr=zs,Xs=function(s){s.registers.FLAG.zero===0&&T.call(this,s)},Ur=Hs,Mr=Gs,zr=Vs,jr=qs,Wr=function(s){s.registers.FLAG.overflow===0&&T.call(this,s)},$s=function(s){s.registers.FLAG.parity===0&&T.call(this,s)},qr=function(s){s.registers.FLAG.sign===0&&T.call(this,s)},Vr=Xs,Gr=function(s){s.registers.FLAG.overflow===1&&T.call(this,s)},Js=function(s){s.registers.FLAG.parity===1&&T.call(this,s)},Hr=Js,Xr=$s,$r=function(s){s.registers.FLAG.sign===1&&T.call(this,s)},Jr=Ws,Ks=function(s){},Kr=function(s){},Qr=function(s){},Zr=function(s){},Qs=function(s){},Zs=function(s){},Yr=function(s){s.registers.AH.value=Z(s.registers.AL.value,1)?255:0},ei=function(s){s.registers.DX.value=Z(s.registers.AX.value,2)?65535:0},ti=function(s){},si=function(s){},ni=function(s){},ri=function(s){},ii=function(s){},oi=function(s){},os=function(s){this.op1.setValue(s,s.pop())},Ys=function(s){s.registers.FLAG.value=s.pop()},Pt=function(s){s.push(this.op1.getValue(s))},en=function(s){s.push(s.registers.FLAG.value)},tn=function(s,e){en.call(this,s),sn.call(this,s),s.registers.FLAG.trap=0,s.push(s.registers.CS.value),s.push(s.registers.IP.value+this.size(s));let t=e??this.op1.getValue(s)*4;s.registers.IP.value=s.memory.get(t,2)-this.size(s),s.registers.CS.value=s.memory.get(t+2,2)},ai=function(s){},ui=function(s){s.registers.IP.value=s.pop()-this.size(s),s.registers.CS.value=s.pop(),Ys.call(this,s)},li=function(s){s.registers.FLAG.carry=0},ci=function(s){s.registers.FLAG.directional=0},sn=function(s){s.registers.FLAG.interrupt=0},hi=function(s){s.registers.FLAG.carry=~s.registers.FLAG.carry},di=function(s){s.registers.AH.value=s.registers.FLAG.sign<<7|s.registers.FLAG.zero<<6|s.registers.FLAG.overflow<<5|s.registers.FLAG.auxilliary<<4|s.registers.FLAG.overflow<<3|s.registers.FLAG.parity<<2|s.registers.FLAG.interrupt<<1|s.registers.FLAG.carry},pi=function(s){s.registers.FLAG.sign=s.registers.AH.value&128,s.registers.FLAG.zero=s.registers.AH.value&64,s.registers.FLAG.auxilliary=s.registers.AH.value&16,s.registers.FLAG.parity=s.registers.AH.value&4,s.registers.FLAG.carry=s.registers.AH.value&1},fi=function(s){s.registers.FLAG.carry=1},mi=function(s){s.registers.FLAG.directional=1},gi=function(s){s.registers.FLAG.interrupt=1},bi=function(){};var E=class{constructor(e,t=n=>n.token.lexeme.toUpperCase()===e){this.name=e;this.isValid=t}},i={AH:new E("AH"),AL:new E("AL"),AX:new E("AX"),BH:new E("BH"),BL:new E("BL"),BRANCH:new E("BRANCH",s=>s instanceof N),BX:new E("BX"),CH:new E("CH"),CL:new E("CL"),CS:new E("CS"),CX:new E("CX"),DADDR:new E("DADDR",s=>s instanceof U),DATA8:new E("DATA8",s=>s instanceof V&&s.size===1),DATA16:new E("DATA16",s=>s instanceof V&&s.size<=2),DH:new E("DH"),DI:new E("DI"),DISP:new E("DISP",s=>s instanceof N),DISP8:new E("DISP8",s=>s instanceof N),DL:new E("DL"),DS:new E("DS"),DX:new E("DX"),ES:new E("ES"),SEGOFF:new E("SEGOFF",s=>s instanceof He),LABEL:new E("LABEL",s=>s instanceof N),N:new E("N",s=>s instanceof V&&s.getValue()>=0&&s.getValue()<=7),PC:new E("PC"),RB:new E("RB",s=>s instanceof J&&["AH","AL","BH","BL","CH","CL","DH","DL"].includes(s.register)),RW:new E("RW",s=>s instanceof J&&["AX","BX","CX","DX","SP","BP","SI","DI"].includes(s.register)),SEGM:new E("SEGM"),SI:new E("SI"),SP:new E("SP"),SR:new E("SR",s=>s instanceof J&&["CS","DS","ES","SS"].includes(s.register)),SS:new E("SS")};var Ct={AL:"000",AX:"000",CL:"001",CX:"001",DL:"010",DX:"010",BL:"011",BX:"011",AH:"100",SP:"100",CH:"100",BP:"100",DH:"100",SI:"100",BH:"100",DI:"100",ES:"00",CS:"01",SS:"10",DS:"11"},l=class{constructor(e,t,n,r,u){this.mnemonic=e;this.op1=t;this.op2=n;this.executor=r;this.format=u}getBinary(e,t){let n=this.format.replace(/\s/g,""),r=/{mod}/i.test(n),u=/{reg}/i.test(n),o=/{seg}/i.test(n),a=/{rm}/i.test(n),c=/{label}/i.test(n),d=/{disp}/i.test(n),p=/{yy}/i.test(n),b=/{yyyy}/i.test(n),f=n,y=new Uint16Array(1),x=new DataView(y.buffer);if(u&&(t.op1 instanceof J?f=f.replace(/{reg}/,Ct[t.op1.register]):t.op2 instanceof J&&(f=f.replace(/{reg}/,Ct[t.op2.register]))),o&&(t.op1 instanceof J?f=f.replace(/{seg}/,Ct[t.op1.register]):t.op2 instanceof J&&(f=f.replace(/{seg}/,Ct[t.op2.register]))),r&&a)if(t.op1 instanceof J&&t.op2 instanceof J)f=f.replace(/{mod}/,"11"),f=f.replace(/{rm}/,Ct[t.op2.register]);else{let S=t.op1 instanceof U?t.op1:t.op2;S instanceof U&&(!S.bpbx&&!S.sidi?(f=f.replace(/{mod}/,"00"),f=f.replace(/{rm}/,"110")):(f=f.replace(/{mod}/,S.imm?S.imm.size===1?"01":"11":"00"),S.bpbx&&S.sidi?f=f.replace(/{rm}/,`0${/BX/i.test(S.bpbx.register)?0:1}${/SI/i.test(S.bpbx.register)?0:1}`):S.bpbx?f=f.replace(/{rm}/,`11${/BX/i.test(S.bpbx.register)?1:0}`):S.sidi&&(f=f.replace(/{rm}/,`10${/SI/i.test(S.sidi.register)?0:1}`))))}if(c){let S=t.op1 instanceof N?t.op1:t.op2;S instanceof N&&(y[0]=S.getValue(e),f=f.replace(/{label}/,x.getUint16(0,!0).toString(2).padStart(16,"0")))}if(d){let S=t.op1 instanceof U?t.op1:t.op2;if(S instanceof U&&S.imm)y[0]=S.imm.getValue(e),f=f.replace(/{disp}/,[x.getUint8(0),x.getUint8(1)].map(h=>h.toString(2).padStart(8,"0")).join(""));else{let h=t.op1 instanceof N?t.op1:t.op2;h instanceof N&&(y[0]=h.getValue(e),f=f.replace(/{disp}/,x.getUint8(0).toString(2).padStart(8,"0")))}}if(p||b){let S=t.op1 instanceof V?t.op1:t.op2;S instanceof V&&(y[0]=S.getValue(e),p?f=f.replace(/{yy}/,x.getUint8(0).toString(2).padStart(8,"0")):f=f.replace(/{yyyy}/,x.getUint16(0,!0).toString(2).padStart(16,"0")))}return f.replace(/[^01]/g,"")}},nn=[new l("LDS",i.RW,i.DADDR,Er,"1100 0101 {mod} {reg} {rm} {disp}"),new l("LEA",i.RW,i.DADDR,Sr,"1000 1101 {mod} {reg} {rm} {disp}"),new l("LES",i.RW,i.DADDR,Ir,"1100 0100 {mod} {reg} {rm} {disp}"),new l("MOV",i.RB,i.DADDR,W,"1000 1010 {mod} {reg} {rm} {disp}"),new l("MOV",i.RW,i.DADDR,W,"1000 1011 {mod} {reg} {rm} {disp}"),new l("MOV",i.DADDR,i.RB,W,"1000 1000 {mod} {reg} {rm} {disp}"),new l("MOV",i.DADDR,i.RW,W,"1000 1001 {mod} {reg} {rm} {disp}"),new l("MOV",i.AL,i.LABEL,W,"1010 0000 {label}"),new l("MOV",i.AX,i.LABEL,W,"1010 0001 {label}"),new l("MOV",i.LABEL,i.AL,W,"1010 0010 {label}"),new l("MOV",i.LABEL,i.AX,W,"1010 0011 {label}"),new l("MOV",i.SR,i.DADDR,W,"1000 1110 {mod} {seg} {rm} {disp}"),new l("MOV",i.DADDR,i.SR,W,"1000 1100 {mod} {seg} {rm} {disp}"),new l("XCHG",i.RB,i.DADDR,pt,"1000 0110 {mod} {reg} {rm} {disp}"),new l("XCHG",i.RW,i.DADDR,pt,"1000 0110 {mod} {reg} {rm} {disp}"),new l("XLAT",null,null,Lr,"1101 0111"),new l("ADC",i.RB,i.DADDR,ce,"0001 0010 {mod} {reg} {rm} {disp}"),new l("ADC",i.RW,i.DADDR,ce,"0001 0011 {mod} {reg} {rm} {disp}"),new l("ADC",i.DADDR,i.RB,ce,"0001 0000 {mod} {reg} {rm} {disp}"),new l("ADC",i.DADDR,i.RW,ce,"0001 0001 {mod} {reg} {rm} {disp}"),new l("ADD",i.RB,i.DADDR,Y,"0000 0010 {mod} {reg} {rm} {disp}"),new l("ADD",i.RW,i.DADDR,Y,"0000 0011 {mod} {reg} {rm} {disp}"),new l("ADD",i.DADDR,i.RB,Y,"0000 0000 {mod} {reg} {rm} {disp}"),new l("ADD",i.DADDR,i.RW,Y,"0000 0001 {mod} {reg} {rm} {disp}"),new l("AND",i.RW,i.DADDR,ne,"0010 0010 {mod} {reg} {rm} {disp}"),new l("AND",i.RB,i.DADDR,ne,"0010 0011 {mod} {reg} {rm} {disp}"),new l("AND",i.DADDR,i.RW,ne,"0010 0001 {mod} {reg} {rm} {disp}"),new l("AND",i.DADDR,i.RB,ne,"0010 0000 {mod} {reg} {rm} {disp}"),new l("CMP",i.RB,i.DADDR,he,"0011 1010 {mod} {reg} {rm} {disp}"),new l("CMP",i.RW,i.DADDR,he,"0011 1011 {mod} {reg} {rm} {disp}"),new l("CMP",i.DADDR,i.RW,he,"0011 1001 {mod} {reg} {rm} {disp}"),new l("CMP",i.DADDR,i.RB,he,"0011 1000 {mod} {reg} {rm} {disp}"),new l("DEC",i.DADDR,null,Kt,"1111 1110 {mod} 001 {rm} {disp}"),new l("DIV",i.DADDR,null,Dt,"1111 0110 {mod} 110 {rm} {disp}"),new l("IDIV",i.DADDR,null,Qt,"1111 0110 {mod} 111 {rm} {disp}"),new l("IMUL",i.DADDR,null,Zt,"1111 0110 {mod} 101 {rm} {disp}"),new l("INC",i.DADDR,null,Yt,"1111 1110 {mod} 000 {rm} {disp}"),new l("MUL",i.DADDR,null,wt,"1111 0110 {mod} 100 {rm} {disp}"),new l("NEG",i.DADDR,null,es,"1111 0110 {mod} 011 {rm} {disp}"),new l("NOT",i.DADDR,null,ts,"1111 0110 {mod} 010 {rm} {disp}"),new l("OR",i.RB,i.DADDR,de,"0000 1010 {mod} {reg} {rm} {disp}"),new l("OR",i.RW,i.DADDR,de,"0000 1011 {mod} {reg} {rm} {disp}"),new l("OR",i.DADDR,i.RB,de,"0000 1000 {mod} {reg} {rm} {disp}"),new l("OR",i.DADDR,i.RW,de,"0000 1001 {mod} {reg} {rm} {disp}"),new l("RCL",i.DADDR,i.N,At,"1101 0000 {mod} 011 {rm} {disp}"),new l("ROL",i.DADDR,i.N,Ve,"1101 0000 {mod} 000 {rm} {disp}"),new l("RCR",i.DADDR,i.N,xt,"1101 0000 {mod} 001 {rm} {disp}"),new l("ROR",i.DADDR,i.N,Et,"1101 0000 {mod} 000 {rm} {disp}"),new l("RCL",i.DADDR,i.CL,At,"1101 0010 {mod} 011 {rm} {disp}"),new l("ROL",i.DADDR,i.CL,Ve,"1101 0010 {mod} 000 {rm} {disp}"),new l("RCR",i.DADDR,i.CL,xt,"1101 0010 {mod} 001 {rm} {disp}"),new l("ROR",i.DADDR,i.CL,Et,"1101 0010 {mod} 000 {rm} {disp}"),new l("SAL",i.DADDR,i.N,Ge,"1101 0000 {mod} 001 {rm} {disp}"),new l("SAR",i.DADDR,i.N,St,"1101 0000 {mod} 111 {rm} {disp}"),new l("SAL",i.DADDR,i.CL,Ge,"1101 0010 {mod} 001 {rm} {disp}"),new l("SAR",i.DADDR,i.CL,St,"1101 0010 {mod} 111 {rm} {disp}"),new l("SBB",i.RB,i.DADDR,ee,"1111 1010 {mod} {reg} {rm} {disp}"),new l("SBB",i.RW,i.DADDR,ee,"1111 1011 {mod} {reg} {rm} {disp}"),new l("SBB",i.DADDR,i.RB,ee,"1111 1000 {mod} {reg} {rm} {disp}"),new l("SBB",i.DADDR,i.RW,ee,"1111 1001 {mod} {reg} {rm} {disp}"),new l("SHR",i.DADDR,i.N,Lt,"1111 0000 {mod} 101 {rm} {disp}"),new l("SHL",i.DADDR,i.N,It,"1111 0001 {mod} 101 {rm} {disp}"),new l("SHR",i.DADDR,i.CL,Lt,"1111 0010 {mod} 101 {rm} {disp}"),new l("SHL",i.DADDR,i.CL,It,"1111 0011 {mod} 101 {rm} {disp}"),new l("SUB",i.RB,i.DADDR,re,"0010 1010 {mod} {reg} {rm} {disp}"),new l("SUB",i.RW,i.DADDR,re,"0010 1011 {mod} {reg} {rm} {disp}"),new l("SUB",i.DADDR,i.RB,re,"0010 1000 {mod} {reg} {rm} {disp}"),new l("SUB",i.DADDR,i.RW,re,"0010 1001 {mod} {reg} {rm} {disp}"),new l("TEST",i.DADDR,i.RB,we,"1000 0100 {mod} {reg} {rm} {disp}"),new l("TEST",i.DADDR,i.RW,we,"1000 0101 {mod} {reg} {rm} {disp}"),new l("XOR",i.RB,i.DADDR,ie,"0011 0010 {mod} {reg} {rm} {disp}"),new l("XOR",i.RW,i.DADDR,ie,"0011 0011 {mod} {reg} {rm} {disp}"),new l("XOR",i.DADDR,i.RB,ie,"0011 0000 {mod} {reg} {rm} {disp}"),new l("XOR",i.DADDR,i.RW,ie,"0011 0001 {mod} {reg} {rm} {disp}"),new l("MOV",i.DADDR,i.DATA8,W,"1100 0110 {mod} 000 {rm} {disp} {yy}"),new l("MOV",i.DADDR,i.DATA16,W,"1100 0111 {mod} 000 {rm} {disp} {yyyy}"),new l("MOV",i.RB,i.DATA8,W,"1011 1 {reg} {yy}"),new l("MOV",i.RW,i.DATA16,W,"1011 1 {reg} {yyyy}"),new l("JMP",i.BRANCH,null,T,"1110 1001 {reg} {disp}"),new l("JMP",i.DATA16,null,T,"1110 1001 {reg} {disp}"),new l("JMP",i.DADDR,null,T,"1111 1111 {mod} 100 {rm} {disp}"),new l("JMP FAR PTR",i.DADDR,null,T,"1111 1111 {mod} 101 {rm} {disp}"),new l("JMP",i.SEGOFF,null,T,"1110 1010 {yyyy}"),new l("JMP",i.RW,null,T,"1111 1111 1110 0 {reg}"),new l("CALL",i.BRANCH,null,ft,"1110 1000 {disp}"),new l("CALL",i.DADDR,null,ft,"1111 1111 {mod} 010 {reg} {disp}"),new l("CALL FAR PTR",i.DADDR,null,ft,"1111 1111 {mod} 011 {rm} {disp}"),new l("CALL",i.SEGOFF,null,ft,"1001 1010 {yyyy}"),new l("CALL",i.RW,null,ft,"1111 1101 0 {rm}"),new l("RET",null,null,ss,"1100 0011"),new l("RET",i.DATA16,null,ss,"1100 0010 {yyyy}"),new l("RETF",null,null,Fs,"1101 0011"),new l("RETF",i.DATA16,null,Fs,"1101 0010 {yyyy}"),new l("ADD",i.AL,i.DATA8,Y,"0000 0100 {yy}"),new l("ADD",i.AX,i.DATA16,Y,"0000 0101 {yyyy}"),new l("ADD",i.RB,i.DATA8,Y,"1000 0000 1100 0 {reg} {yy}"),new l("ADD",i.RW,i.DATA16,Y,"1000 0001 1100 0 {reg} {yyyy}"),new l("ADD",i.DADDR,i.DATA8,Y,"1000 0000 {mod} 000 {rm} {yy}"),new l("ADD",i.DADDR,i.DATA16,Y,"1000 0001 {mod} 000 {rm} {yyyy}"),new l("ADC",i.AL,i.DATA8,ce,"0001 0100 {yy}"),new l("ADC",i.AX,i.DATA16,ce,"0001 0101 {yyyy}"),new l("ADC",i.RB,i.DATA8,ce,"1000 0000 1101 {reg} {yy}"),new l("ADC",i.RW,i.DATA16,ce,"1000 0001 1101 {reg} {yyyy}"),new l("ADC",i.DADDR,i.DATA8,ce,"1000 0000 {mod} 010 {rm} {disp} {yy}"),new l("ADC",i.DADDR,i.DATA16,ce,"1000 0001 {mod} 010 {rm} {disp} {yyyy}"),new l("AND",i.AL,i.DATA8,ne,"0010 0100 {yy}"),new l("AND",i.AX,i.DATA16,ne,"0010 0101 {yyyy}"),new l("AND",i.RB,i.DATA8,ne,"1000 0000 1110 0 {reg} {yy}"),new l("AND",i.RW,i.DATA16,ne,"1000 0001 1110 0 {reg} {yyyy}"),new l("AND",i.DADDR,i.DATA8,ne,"1000 0000 {reg} 100 {rm} {disp} {yy}"),new l("AND",i.DADDR,i.DATA16,ne,"1000 0001 {mod} 100 {rm} {disp} {yyyy}"),new l("CMP",i.AL,i.DATA8,he,"0011 1100 {yy}"),new l("CMP",i.AX,i.DATA16,he,"0011 1101 {yyyy}"),new l("CMP",i.RB,i.DATA8,he,"1000 0000 1111 1 {reg} {yy}"),new l("CMP",i.RW,i.DATA16,he,"1000 0001 1111 {reg} {yyyy}"),new l("CMP",i.DADDR,i.DATA8,he,"1000 0000 {mod} 111 {rm} {disp} {yy}"),new l("CMP",i.DADDR,i.DATA16,he,"1000 0001 {mod} 111 {rm} {disp} {yyyy}"),new l("OR",i.AL,i.DATA8,de,"0000 1100 {yy}"),new l("OR",i.AX,i.DATA16,de,"0000 1101 {yyyy}"),new l("OR",i.RB,i.DATA8,de,"1000 0000 1100 01 {reg} {yyyy}"),new l("OR",i.RW,i.DATA16,de,"1000 0001 1100 01 {reg} {yyyy}"),new l("OR",i.DADDR,i.DATA8,de,"1000 0000 {mod} 001 {rm} {disp} {yyyy}"),new l("OR",i.DADDR,i.DATA16,de,"1000 0001 {mod} 001 {rm} {disp} {yyyy}"),new l("SBB",i.AL,i.DATA8,ee,"0001 1100 0 {yy}"),new l("SBB",i.AX,i.DATA16,ee,"0001 11001 {yyyy}"),new l("SBB",i.RW,i.DATA16,ee,"1000 0000 1100 01 {reg} {yyyy}"),new l("SBB",i.RB,i.DATA8,ee,"1000 0001 1101 {reg} {disp} {yy}"),new l("SBB",i.DADDR,i.DATA8,ee,"1000 0000 {mod} 001 {rm} {disp} {yyyy}"),new l("SBB",i.DADDR,i.DATA16,ee,"1000 0001 {mod} 001 {rm} {disp} {yyyy}"),new l("SUB",i.AL,i.DATA8,re,"0010 1100 {yy}"),new l("SUB",i.AX,i.DATA16,re,"0010 1101 {yyyy}"),new l("SUB",i.RB,i.DATA8,re,"1000 0000 1110 1 {reg} {yy}"),new l("SUB",i.RW,i.DATA16,re,"1000 0001 1110 1 {reg} {yyyy}"),new l("SUB",i.DADDR,i.DATA8,re,"1000 0000 {mod} 101 {rm} {disp} {yy}"),new l("SUB",i.DADDR,i.DATA16,re,"1000 0001 {mod} 101 {rm} {disp} {yyyy}"),new l("TEST",i.AL,i.DATA8,we,"1010 1000 {yy}"),new l("TEST",i.AX,i.DATA16,we,"1010 1001 {yyyy}"),new l("TEST",i.RB,i.DATA8,we,"1111 0110 1100 0 {reg} {yy}"),new l("TEST",i.RW,i.DATA16,we,"1111 0111 1100 0 {reg} {yyyy}"),new l("TEST",i.DADDR,i.DATA8,we,"1111 0110 {mod} 000 {rm} {disp} {yy}"),new l("TEST",i.DADDR,i.DATA16,we,"1111 0111 {mod} 000 {rm} {disp} {yyyy}"),new l("XOR",i.AL,i.DATA8,ie,"0011 0100 {yy}"),new l("XOR",i.AX,i.DATA16,ie,"0011 0101 {yyyy}"),new l("XOR",i.RB,i.DATA8,ie,"1000 0000 1111 0 {reg} {yy}"),new l("XOR",i.RW,i.DATA16,ie,"1000 0001 1100 0 {reg} {yyyy}"),new l("XOR",i.DADDR,i.DATA8,ie,"1000 0000 {mod} 010 {rm} {disp} {yy}"),new l("XOR",i.DADDR,i.DATA16,ie,"1000 0001 {mod} 010 {rm} {disp} {yyyy}"),new l("LOOP",i.DISP8,null,ns,"1110 0010 {disp}"),new l("LOOPE",i.DISP8,null,Us,"1110 0001 {disp}"),new l("LOOPNE",i.DISP8,null,Ms,"1110 0000 {disp}"),new l("LOOPNZ",i.DISP8,null,Pr,"1110 0000 {disp}"),new l("LOOPZ",i.DISP8,null,Cr,"1110 0001 {disp}"),new l("JA",i.DISP8,null,zs,"0111 0111 {disp}"),new l("JAE",i.DISP8,null,rs,"0111 0011 {disp}"),new l("JB",i.DISP8,null,is,"0111 0010 {disp}"),new l("JC",i.DISP8,null,kr,"0111 0010 {disp}"),new l("JBE",i.DISP8,null,js,"0111 0110 {disp}"),new l("JCXZ",i.DISP8,null,Or,"1110 0011 {disp}"),new l("JE",i.DISP8,null,Ws,"0111 0100 {disp}"),new l("JG",i.DISP8,null,qs,"0111 1111 {disp}"),new l("JGE",i.DISP8,null,Vs,"0111 1101 {disp}"),new l("JL",i.DISP8,null,Gs,"0111 1100 {disp}"),new l("JLE",i.DISP8,null,Hs,"0111 1110 {disp}"),new l("JNA",i.DISP8,null,Br,"0111 0110 {disp}"),new l("JNAE",i.DISP8,null,Tr,"0111 0010 {disp}"),new l("JNB",i.DISP8,null,Nr,"0111 0111 {disp}"),new l("JNC",i.DISP8,null,_r,"0111 0111 {disp}"),new l("JNBE",i.DISP8,null,Fr,"0111 0111 {disp}"),new l("JNE",i.DISP8,null,Xs,"0111 0101 {disp}"),new l("JNG",i.DISP8,null,Ur,"0111 0111 {disp}"),new l("JNGE",i.DISP8,null,Mr,"0111 0111 {disp}"),new l("JNL",i.DISP8,null,zr,"0111 0111 {disp}"),new l("JNLE",i.DISP8,null,jr,"0111 0111 {disp}"),new l("JNO",i.DISP8,null,Wr,"0111 0001 {disp}"),new l("JNP",i.DISP8,null,$s,"0111 1011 {disp}"),new l("JNS",i.DISP8,null,qr,"0111 1001 {disp}"),new l("JNZ",i.DISP8,null,Vr,"0111 0111 {disp}"),new l("JO",i.DISP8,null,Gr,"0111 0000 {disp}"),new l("JP",i.DISP8,null,Js,"0111 1010 {disp}"),new l("JPE",i.DISP8,null,Hr,"0111 0111 {disp}"),new l("JPO",i.DISP8,null,Xr,"0111 0111 {disp}"),new l("JS",i.DISP8,null,$r,"0111 1000 {disp}"),new l("JZ",i.DISP8,null,Jr,"0111 0111 {disp}"),new l("MOV",i.RB,i.RB,W,"1000 1010 11 {reg} {reg}"),new l("MOV",i.RW,i.RW,W,"1000 1011 11 {reg} {reg}"),new l("MOV",i.SR,i.RW,W,"1000 1110 110 {seg} {reg}"),new l("MOV",i.RW,i.SR,W,"1000 1100 110 {seg} {reg}"),new l("XCHG",i.AX,i.RW,pt,"1001 0 {reg}"),new l("XCHG",i.RB,i.RB,pt,"1000 0110 11 {reg} {reg}"),new l("XCHG",i.RB,i.RB,pt,"1000 0111 11 {reg} {reg}"),new l("CMPS",null,null,Ks,"1010 0110"),new l("CMPS",null,null,Ks,"1010 0111"),new l("LODS",null,null,Kr,"1010 1100"),new l("MOVS",null,null,Qr,"1010 0101"),new l("REP",i.N,null,Zr,"1111 0010"),new l("SCAS",null,null,Qs,"1010 1110"),new l("SCAS",null,null,Qs,"1010 1111"),new l("STOS",null,null,Zs,"1010 1010"),new l("STOS",null,null,Zs,"1010 1011"),new l("ADC",i.RB,i.RB,ce,"0001 0010 11 {reg} {reg}"),new l("ADC",i.RW,i.RW,ce,"0001 0011 11 {reg} {reg}"),new l("ADD",i.RB,i.RB,Y,"0000 0010 11 {reg} {reg}"),new l("ADD",i.RW,i.RW,Y,"0000 0011 11 {reg} {reg}"),new l("AND",i.RB,i.RB,ne,"0010 0010 11 {reg} {reg}"),new l("AND",i.RB,i.RB,ne,"0010 0011 11 {reg} {reg}"),new l("CBW",null,null,Yr,"1001 1000"),new l("CMP",i.RB,i.RB,he,"0011 1010 11 {reg} {reg}"),new l("CMP",i.RW,i.RW,he,"0011 1011 11 {reg} {reg}"),new l("CWD",null,null,ei,"1001 1001"),new l("DIV",i.RB,null,Dt,"1111 0110 1111 0 {reg}"),new l("DIV",i.RW,null,Dt,"1111 0111 1111 0 {reg}"),new l("IDIV",i.RB,null,Qt,"1111 0110 1111 1 {reg}"),new l("IDIV",i.RW,null,Qt,"1111 0111 1111 1 {reg}"),new l("IMUL",i.RB,null,Zt,"1111 0110 1110 1 {reg}"),new l("IMUL",i.RW,null,Zt,"1111 0111 1110 1 {reg}"),new l("MUL",i.RB,null,wt,"1111 0110 1110 0 {reg}"),new l("MUL",i.RW,null,wt,"1111 0111 1110 0 {reg}"),new l("OR",i.RB,null,de,"0000 1010 11 {reg} {reg}"),new l("OR",i.RW,null,de,"0000 1011 11 {reg} {reg}"),new l("SBB",i.RB,null,ee,"0001 1010 11 {reg} {reg}"),new l("SBB",i.RW,null,ee,"0001 1011 11 {reg} {reg}"),new l("SBB",i.RB,null,ee,"0010 1010 11 {reg} {reg}"),new l("SBB",i.RW,null,ee,"0010 1011 11 {reg} {reg}"),new l("TEST",i.RB,null,we,"1000 0100 11 {reg} {reg}"),new l("TEST",i.RW,null,we,"1000 0101 11 {reg} {reg}"),new l("XOR",i.RB,null,ie,"0011 0000 11 {reg} {reg}"),new l("XOR",i.RW,null,ie,"0011 0001 11 {reg} {reg}"),new l("XOR",i.RB,null,ie,"0011 0000 11 {reg} {reg}"),new l("AAA",null,null,ti,"0011 1111"),new l("AAD",null,null,si,"1101 0101 0000 1010"),new l("AAM",null,null,ni,"1101 0100 0000 1010"),new l("AAS",null,null,ri,"0011 1111"),new l("DAA",null,null,ii,"0010 0111"),new l("DAS",null,null,oi,"0010 1111"),new l("DEC",i.RB,null,Kt,"1111 1110 1110 1 {reg}"),new l("DEC",i.RW,null,Kt,"0100 1 {reg}"),new l("INC",i.RB,null,Yt,"1111 1110 0 {reg}"),new l("INC",i.RW,null,Yt,"0100 0 {reg}"),new l("NEG",i.RB,null,es,"1111 0110 1101 1 {reg}"),new l("NEG",i.RW,null,es,"1111 0111 1101 1 {reg}"),new l("NOT",i.RB,null,ts,"1111 0110 1101 0 {reg}"),new l("NOT",i.RW,null,ts,"1111 0111 1101 0 {reg}"),new l("RCL",i.RB,i.N,At,"1101 0000 1101 0 {reg}"),new l("RCL",i.RW,i.N,At,"1101 0001 1101 0 {reg}"),new l("RCR",i.RB,i.N,xt,"1101 0000 1101 1 {reg}"),new l("RCR",i.RW,i.N,xt,"1101 0001 1101 1 {reg}"),new l("ROL",i.RB,i.N,Ve,"1101 0000 1100 0 {reg}"),new l("ROL",i.RW,i.N,Ve,"1101 0001 1100 0 {reg}"),new l("ROR",i.RB,i.N,Et,"1101 0000 1100 1 {reg}"),new l("ROR",i.RW,i.N,Et,"1101 0001 1100 1 {reg}"),new l("SAL",i.RB,i.N,Ge,"1101 0000 1110 0 {reg}"),new l("SAL",i.RW,i.N,Ge,"1101 0001 1110 0 {reg}"),new l("SAR",i.RB,i.N,St,"1101 0000 1111 1 {reg}"),new l("SAR",i.RW,i.N,St,"1101 0001 1111 1 {reg}"),new l("SHL",i.RB,i.N,It,"1101 0000 1110 1 {reg}"),new l("SHL",i.RW,i.N,It,"1101 0010 1110 1 {reg}"),new l("SHR",i.RB,i.N,Lt,"1101 0000 1110 1 {reg}"),new l("SHR",i.RW,i.N,Lt,"1101 0001 1110 1 {reg}"),new l("POP",i.DADDR,null,os,"1000 1111 {mod} 000 {rm} {disp}"),new l("POP",i.RW,null,os,"0101 1 {reg}"),new l("POP",i.SR,null,os,"000 {seg} 111"),new l("POPF",null,null,Ys,"1001 1101"),new l("PUSH",i.DADDR,null,Pt,"1111 1111 {mod} 110 {rm} {disp}"),new l("PUSH",i.RW,null,Pt,"0101 0 {reg}"),new l("PUSH",i.SR,null,Pt,"000 {seg} 110"),new l("PUSH",i.SR,null,Pt,"1001 1100"),new l("PUSHF",null,null,en,"0001 0000"),new l("INT",i.DATA8,null,tn,"1100 1100"),new l("INTO",null,null,ai,"1100 1110"),new l("IRET",null,null,ui,"1100 1111"),new l("CLC",null,null,li,"1111 1000"),new l("CLD",null,null,ci,"1111 1100"),new l("CLI",null,null,sn,"1111 1010"),new l("CMC",null,null,hi,"1111 0101"),new l("LAHF",null,null,di,"1001 1111"),new l("SAHF",null,null,pi,"1001 1110"),new l("STC",null,null,fi,"1111 1001"),new l("STD",null,null,mi,"1111 1101"),new l("STI",null,null,gi,"1111 1011"),new l("NOP",null,null,bi,"1001 0000")],vi=(s,e,t)=>nn.find(n=>n.mnemonic===s.toUpperCase()&&(!n.op1||!e||n.op1.isValid(e))&&(!n.op2||!t||n.op2.isValid(t)));var kt=["AL","AH","AX","BL","BH","BX","CL","CH","CX","DL","DH","DX","DI","SI","BP","SP","DS","ES","SS","CS","IP"];var Pe=class{constructor(e){this.token=e;this.type=this.constructor.name}getSegment(e){return e.segments.find(t=>e.hasNode(t,this))?.location||e.registers.CS.value*16}},$e=class extends Pe{constructor(e,t){super(e);this.size=t}getUnsigned(e){return new(this.size===1?Uint8Array:Uint16Array)([this.getValue(e)])[0]}getSigned(e){let t=new DataView(new(this.size===1?Uint8Array:Uint16Array)([this.getValue(e)]).buffer);return this.size===1?t.getInt8(0):t.getInt16(0,!0)}},V=class extends $e{constructor(e){let t,n;if(e.type===2&&e.lexeme.length<=2)t=e.lexeme.charCodeAt(0),n=1,e.lexeme.length===2&&(t<<=8,t+=e.lexeme.charCodeAt(1),n=2);else{let r=_e(e.lexeme);if(!r)throw new Ls(e);t=r.value,n=r.size}super(e,n);this.value=new Uint16Array(1),this.value[0]=t}getValue(e){return this.value[0]}setValue(e,t){this.value[0]=t}},J=class extends $e{constructor(e){let t=kt.find(n=>n===e.lexeme.toUpperCase());if(!t)throw new Ps(e);super(e,/L|H$/i.test(e.lexeme)?1:2);this.register=t}getValue(e){return e.registers[this.register].value}setValue(e,t){e.registers[this.register].value=t}},U=class extends $e{constructor(e,t,n,r,u=!0,o=0,a=null){super(e,o);this.bpbx=t;this.sidi=n;this.imm=r;this.imm_sign=u;this.size=o;this.base=a}getValue(e){return e.memory.get(this.getAddress(e),this.size)}setValue(e,t){let n=this.getAddress(e);e.memory.set(n,t,this.size)}getAddress(e){let t;return this.base?t=e.dataLabels.find(r=>r.name===this.base)?.location??e.registers[this.base.toUpperCase()]?.value*16??e.registers.DS.value*16:t=e.registers.DS.value*16,t+(this.bpbx?this.bpbx.getValue(e):0)+(this.sidi?this.sidi.getValue(e):0)+(this.imm?this.imm.getValue(e)*(this.imm_sign?1:-1):0)}},as=class extends V{constructor(e){super(new j(0,"0",new qe));this.valueGetter=e}getValue(e){return this.valueGetter(e)}},N=class extends U{constructor(e,t=0){if(e.type!==1)throw new ct(e);super(e,null,null,null,!0,t);this.label=e.lexeme,this.imm=new as(n=>this.getValue(n))}getValue(e){return this.getNode(e)instanceof Ze?super.getValue(e):this.getOffset(e)}getAddress(e){let t=this.getNode(e)?.location;return t||0}getDisp(e){let t=this.getNode(e);return t?.location?t.location-(t.getSegment(e)+e.registers.IP.value):0}getOffset(e){return this.getDisp(e)+e.registers.IP.value}getNode(e){return this.node||(this.node=e.dataLabels.find(t=>t.name===this.label)||e.labels.find(t=>t.name===this.label)||e.procs.find(t=>t.name===this.label)||e.segments.find(t=>t.name===this.label))}},He=class extends $e{constructor(e,t,n){super(e,2);this.segment=t;this.offset=n}getValue(e){return this.segment.getUnsigned(e)*16+this.offset.getUnsigned(e)}setValue(e,t){}},ge=class extends Pe{constructor(e,t,n,r=!1){if(n instanceof V&&t?.size===2&&(n.size=2),!n&&t instanceof U&&t.size===0&&r&&(t.size=2),t&&n instanceof U&&n.size===0?n.size=t.size:n&&t instanceof U&&(!t.base||kt.includes(t.base?.toUpperCase()))&&!(t instanceof N&&n instanceof V)&&t.size===0&&(t.size=n.size),t&&n&&t.size!==0&&n.size!==0&&t.size<n.size)throw new Error("Size mismatch between operands");t instanceof U&&t.size===0&&["JMP","CALL","POP","PUSH"].includes(e.lexeme)&&(t.size=2);let u=vi(r?`${e.lexeme} FAR PTR`:e.lexeme,t,n);if(!u)throw new lt(e,t?.token,n?.token);super(e);this.op1=t;this.op2=n;this.farptr=r;this.instruction=u}execute(e){this.instruction.executor.call(this,e)}getUnsigned(e){return[this.op1?.getUnsigned(e),this.op2?.getUnsigned(e)]}getSigned(e){return[this.op1?.getSigned(e),this.op2?.getSigned(e)]}size(e){let t=this.instruction.getBinary(e,this);return Math.ceil(t.length/8)}},Ot=class extends Pe{constructor(e){if(e.type!==1)throw new ct(e);super(e);this.name=e.lexeme}get location(){return this.instrNode?.location}},Bt=class extends Pe{constructor(e,t,n,r){super(e);this.alignmentType=t;this.combineType=n;this.className=r;this.name=e.lexeme,this.nodes=[]}get location(){return this.nodes.find(e=>e.location).location}},us=class extends Pe{constructor(e,t){super(e);this.size=t}},ls=class extends us{constructor(e){let t=_e(e.lexeme);if(!t)throw new Cs(e);super(e,t.size);this.value=t.value}writeToMemory(e,t,n=this.size){return e.memory.set(t,this.value,n),n}},cs=class extends us{constructor(e){super(e,1);this.value=e.lexeme}writeToMemory(e,t,n=this.size){let r=this.value.split("");for(let u of r)e.memory.set(t,u.charCodeAt(0),n),t+=n;return r.length*n}},hs=class extends us{constructor(e){super(e,1)}writeToMemory(e,t,n=this.size){return n}},Ze=class extends Pe{constructor(e,t,n){super(e);this.size=t;this.values=n;this.name=e.lexeme}get totalSize(){let e=0;for(let t of this.values)t instanceof cs?e+=t.value.length*this.size:e+=this.size;return e}},Xe=class extends Pe{constructor(e,t){super(e);this.near=t;this.name=e.lexeme,this.nodes=[]}get location(){return this.nodes.find(e=>e.location).location}},Tt=class extends Pe{constructor(e){super(e);this.label=e.lexeme}},Nt=class extends Pe{constructor(e,t,n,r,u){super(e);this.cs=t;this.ds=n;this.ss=r;this.es=u}},mt=class extends ge{constructor(e,t){super(new j(1,"iret",new qe));this.cpu=e;this.index=t;this.segment=62464,this.offset=368+Math.floor(t/4)*10,this.location=this.segment*16+this.offset,this.executor=e.int[t];let n=this.instruction.getBinary(e,this),r=Math.ceil(n.length/8);e.memory.set(this.location,parseInt(n,2),r,!1),e.memory.set(t*4,this.offset,2,!1),e.memory.set(t*4+2,this.segment,2,!1)}execute(e){this.executor(e),super.execute(e)}};var yi=s=>/[ \t]/.test(s),Ri=s=>/\d/.test(s),rn=s=>/[a-zA-Z0-9_]/.test(s);var on=class{constructor(e){this.contents=e;this.index=0,this.pos=new qe}next(){this.skipWhitespace();let e=this.peek();if(!e||e==="\0")return this.end();if(/[\r\n]/.test(this.peek()))return this.newline();if(Ri(e)||e==="-")return this.number();if(rn(e))return this.identifier();if(e==="'"||e==='"')return this.string();if(e===";")return this.comment();{let t;switch(e){case"(":t=4;break;case")":t=5;break;case"[":t=6;break;case"]":t=7;break;case",":t=8;break;case":":t=9;break;case"?":t=10;break;case"+":t=11;break;case"-":t=12;break;default:return this.unknown()}let n={...this.pos};return new j(t,this.get(),n)}}identifier(){let{start:e,pos:t}=this.state;for(;rn(this.peek());)this.get();return new j(1,this.getSliceFrom(e),t)}number(){let{start:e,pos:t}=this.state;if(this.peek()==="0"&&(this.get(),this.peek().toLowerCase()==="b"))for(this.get();this.peek()==="0"||this.peek()==="1";)this.get();for(this.peek()==="-"&&this.get();/[0-9a-f]/i.test(this.peek());)this.get();this.peek().toLowerCase()==="h"&&this.get();let n=this.getSliceFrom(e);return n==="-"?new j(12,n,t):new j(0,this.getSliceFrom(e),t)}string(){let e=this.get(),{start:t,pos:n}=this.state,r="";for(;r==="\\"||(r=this.peek())!==e;)if(this.get()==="\0")throw new Bs(new j(2,this.getSliceFrom(t),n));let u=this.index;return this.get(),new j(2,this.getSliceFrom(t,u),n)}comment(){let{start:e,pos:t}=this.state;for(this.get();!/[\r\n\0]/.test(this.peek());)this.get();return new j(3,this.getSliceFrom(e),t)}end(){let{start:e,pos:t}=this.state;return this.get(),new j(13,this.getSliceFrom(e),t)}unknown(){let{start:e,pos:t}=this.state;return this.get(),new j(14,this.getSliceFrom(e),t)}newline(){let{start:e,pos:t}=this.state;for(;/[\r\n]/.test(this.peek());)this.get();return new j(15,this.getSliceFrom(e),t)}peek(){return this.contents.charAt(this.index)||"\0"}get(){let e=this.contents.charAt(this.index++);return e===`
`?(this.pos.line++,this.pos.column=1):this.pos.column++,e||"\0"}skipWhitespace(){for(;yi(this.peek());)this.get()}getSliceFrom(e,t=this.index){return this.contents.slice(e,t)}get state(){return{start:this.index,pos:{...this.pos}}}};var _t=(r=>(r[r.BYTE=0]="BYTE",r[r.WORD=1]="WORD",r[r.PARA=2]="PARA",r[r.PAGE=3]="PAGE",r))(_t||{}),ds=(r=>(r[r.PUBLIC=0]="PUBLIC",r[r.COMMON=1]="COMMON",r[r.STACK=2]="STACK",r[r.AT=3]="AT",r))(ds||{});var Ye=class{constructor(e,t=null){this.context=t;this.identifier=this.getTypeClassifier(1);this.comma=this.getTypeClassifier(8);this.colon=this.getTypeClassifier(9);this.lsquare=this.getTypeClassifier(6);this.rsquare=this.getTypeClassifier(7);this.plus=this.getTypeClassifier(11);this.minus=this.getTypeClassifier(12);this.string=this.getTypeClassifier(2);this.qmark=this.getTypeClassifier(10);this.newline=this.getTypeClassifier(15);this.instrOp1Op2Pattern=[[this.instruction],[this.memory,this.segoff,this.immediate,this.register,this.label],[this.comma],[this.memory,this.segoff,this.immediate,this.register,this.label]];this.instrOp1Pattern=[[this.instruction],[this.memory,this.segoff,this.immediate,this.register,this.label]];this.instrPattern=[[this.instruction]];this.labelPattern=[[this.identifier],[this.colon]];this.segmentStartPattern=[[this.identifier],[this.getRegexClassifier(/^SEGMENT$/i)],[this.segmentOptions]];this.segmentEndPattern=[[this.identifier],[this.getRegexClassifier(/^ENDS$/i)]];this.procedureStartPattern=[[this.identifier],[this.getRegexClassifier(/^PROC$/i)],[this.getRegexClassifier(/^(NEAR)|(FAR)$/i)]];this.procedureEndPattern=[[this.identifier],[this.getRegexClassifier(/^ENDP$/i)]];this.dataPattern=[[this.identifier],[this.dataSize],[this.data]];this.data2Pattern=[[this.dataSize],[this.data]];this.assumePattern=[[this.getRegexClassifier(/^ASSUME$/i)],[this.assume]];this.endPattern=[[this.getRegexClassifier(/^END$/i)],[this.identifier]];this.lexer=new on(e),this.tokens=[],this.nodes=[]}parse(){this.tokens=[];let e;for(;(e=this.lexer.next()).type!==13;)this.tokens.push(e);this.tokens.push(new j(15,`
`,this.tokens[this.tokens.length-1].pos)),this.nodes=[];let t=null,n=null,r=null;for(let u=0;u<this.tokens.length;u++){if(this.tokens[u].type===14)throw new De(this.tokens[u]);let o=null,a=null;if(a=this.matchPatternAt(u,this.segmentStartPattern)){let c=a[0][0],d=a[2],p=d.map(y=>y.type===1&&_t[y.lexeme.toUpperCase()]).find(y=>typeof y=="number"),b=d.map(y=>y.type===1&&ds[y.lexeme.toUpperCase()]).find(y=>typeof y=="number"),f=d.find(y=>y.type===2)?.lexeme;n=new Bt(c,p,b,f)}else if(a=this.matchPatternAt(u,this.segmentEndPattern)){let c=a[0][0];if(!n)throw new De(c);if(n.name!==c.lexeme)throw new ks(c);this.nodes.push(n),n=null}else if(this.context==="watch"&&(a=this.matchPatternAt(u,[[this.memory,this.immediate,this.register,this.identifier]])))o=this.getOperand(u)??null,o&&o.size===0&&(o.size=1);else if(a=this.matchPatternAt(u,this.labelPattern))t=new Ot(a[0][0]);else if(a=this.matchPatternAt(u,this.procedureStartPattern))r=new Xe(a[0][0],/NEAR/i.test(a[2][0].lexeme));else if(a=this.matchPatternAt(u,this.procedureEndPattern)){let c=a[0][0];if(!r)throw new De(c);if(r.name!==c.lexeme)throw new Os(c);o=r,r=null}else if(a=this.matchPatternAt(u,this.endPattern))o=new Tt(a[1][0]);else if(a=this.matchPatternAt(u,this.assumePattern)){let c,d,p,b;for(let f=0;f<a[1].length;f+=4){let y=a[1][f].lexeme.toUpperCase(),x=a[1][f+2].lexeme;switch(y){case"CS":c=x;break;case"DS":d=x;break;case"SS":p=x;break;case"ES":b=x;break}}o=new Nt(a[0][0],c,d,p,b)}else if((a=this.matchPatternAt(u,this.dataPattern))||(a=this.matchPatternAt(u,this.data2Pattern))){let c=(a.length===3?a[2]:a[1]).filter(p=>p.type!==8),d=[];for(let p=0;p<c.length;p++)if(p<c.length-4&&/^DUP$/i.test(c[p+1].lexeme)){let b=_e(c[p].lexeme)?.value;for(let f=0;f<b;f++)d.push(c[p+3].type===10?new hs(new j(10,c[p+3].lexeme,c[p].pos)):new ls(new j(0,c[p+3].lexeme,c[p].pos)));p+=4}else d.push(c[p].type===0?new ls(c[p]):c[p].type===2?new cs(c[p]):new hs(c[p]));o=new Ze(a.length===3?a[0][0]:new j(1,"",a[0][0].pos),se[(a.length===3?a[1][0]:a[0][0]).lexeme.toUpperCase()],d)}else if(a=this.matchPatternAt(u,this.instrOp1Op2Pattern)){let c=this.getOperand(u+a[0].length),d=this.getOperand(u+a[0].length+a[1].length+1);o=new ge(a[0][0],c,d,a[0].length>1)}else(a=this.matchPatternAt(u,this.instrOp1Pattern))?o=new ge(a[0][0],this.getOperand(u+a[0].length),void 0,a[0].length>1):(a=this.matchPatternAt(u,this.instrPattern))&&(o=new ge(a[0][0]));if(t&&o){if(!(o instanceof ge))throw new ct(t.token);t.instrNode=o,o=t,t=null}o&&(r?r.nodes.push(o):n?n.nodes.push(o):this.nodes.push(o)),a&&(u+=a.reduce((c,d)=>c+d.length,0),u--)}if(n)throw new Ns(n.token);if(r)throw new _s(r.token);return this.nodes}immediate(e){let t=this.tokens[e];return t.type===0&&_e(t.lexeme)||t.type===2&&t.lexeme.length<=2?[t]:null}register(e){let t=this.tokens[e];return t.type===1&&kt.find(n=>n===t.lexeme.toUpperCase())?[t]:null}label(e){let t=this.tokens[e];return e<this.tokens.length-1&&/^OFFSET$/i.test(t.lexeme)&&this.identifier(e+1)?[t,this.tokens[e+1]]:this.identifier(e)?[t]:null}memory(e){let t=e;if(e<this.tokens.length-1&&/^(WORD|BYTE) PTR$/i.test(`${this.tokens[e].lexeme} ${this.tokens[e+1].lexeme}`)&&(t+=2),t<this.tokens.length&&this.identifier(t)&&(t+=1,t<this.tokens.length&&this.colon(t)&&(t+=1)),this.tokens[t].type!==6)return null;let n=e;for(;n<this.tokens.length&&!this.isLineEnd(this.tokens[n])&&this.tokens[n].type!==7;)n++;if(this.tokens[n].type!==7)throw new Ts(this.tokens[e]);let r=!1,u=!1,o=!1,a=!1,c=[];for(let d=e;d<=t;d++)c.push(this.tokens[d]);for(let d=t+1;d<n;d++){let p=this.tokens[d].lexeme,b=_e(p);if(!a&&!r&&this.register(d)&&/BP|BX/i.test(p))r=!0,a=!0;else if(!a&&!u&&this.register(d)&&/SI|DI/i.test(p))u=!0,a=!0;else if(!a&&!o&&this.immediate(d)&&b&&b.size<=2)o=!0,a=!0;else if(this.plus(d)||this.minus(d))if(a)a=!1;else throw new De(this.tokens[d]);else throw new De(this.tokens[d]);c.push(this.tokens[d])}return c.push(this.tokens[n]),c}segoff(e){return e<this.tokens.length-2&&this.tokens[e].type===0&&this.tokens[e+1].type===9&&this.tokens[e+2].type===0?[this.tokens[e],this.tokens[e+1],this.tokens[e+2]]:null}instruction(e){let t=this.tokens[e];return e<this.tokens.length-2&&t.type===1&&/^FAR PTR$/i.test(`${this.tokens[e+1].lexeme} ${this.tokens[e+2].lexeme}`)?[t,this.tokens[e+1],this.tokens[e+2]]:t.type===1?[t]:null}alignmentType(e){let t=this.tokens[e];return t.type===1&&Object.values(_t).includes(t.lexeme.toUpperCase())?[t]:null}combineType(e){let t=this.tokens[e];return t.type===1&&Object.values(ds).includes(t.lexeme.toUpperCase())?[t]:null}segmentOptions(e){let t=[this.alignmentType,this.combineType,this.string],n;for(n=e;n<e+3&&n<this.tokens.length&&!this.isLineEnd(this.tokens[n]);n++){let r=t.findIndex(u=>u.call(this,n)!==null);if(r===-1)return null;t=[...t.slice(0,r),...t.slice(r+1,t.length)]}return this.tokens.slice(e,n)}dup(e){return e+4<this.tokens.length&&this.tokens[e].type===0&&/^DUP$/i.test(this.tokens[e+1].lexeme)&&this.tokens[e+2].type===4&&(this.tokens[e+3].type===0||this.tokens[e+3].type===10)&&this.tokens[e+4].type===5?this.tokens.slice(e,e+5):null}data(e){let t=[this.dup,this.immediate,this.string,this.qmark],n=[],r=!1,u;for(u=e;u<this.tokens.length&&!this.isLineEnd(this.tokens[u]);u++)if(r)if(this.tokens[u].type===8)r=!1,n.push(this.tokens[u]);else throw new De(this.tokens[u]);else{if(this.tokens[u].type===8)throw new De(this.tokens[u]);let o=null;for(let a of t)if(o=a.call(this,u),o)break;if(o)r=!0,n=n.concat(o),u+=o.length-1;else throw new De(this.tokens[u])}return n}dataSize(e){let t=this.tokens[e];return t.type===1&&Object.keys(se).includes(t.lexeme.toUpperCase())?[t]:null}assume(e){let t=[];for(let n=e;n<this.tokens.length&&!this.isLineEnd(this.tokens[n]);n+=3){let r=this.tokens[n],u=this.tokens[n+2];if(!["CS","DS","ES","SS"].includes(r.lexeme.toString().toUpperCase())||u.type!==1)throw new De(r);t.push(this.tokens[n],this.tokens[n+1],this.tokens[n+2]),this.tokens[n+3].type===8&&(t.push(this.tokens[n+3]),n++)}return t}getTypeClassifier(e){return t=>this.tokens[t].type===e?[this.tokens[t]]:null}getRegexClassifier(e){return t=>this.tokens[t].type===1&&e.test(this.tokens[t].lexeme)?[this.tokens[t]]:null}matchPatternAt(e,t){let n=0,r=[];for(let u=0;u<t.length;u++){if(e+n>=this.tokens.length)return null;let a=t[u].map(c=>c.call(this,e+n)).find(Boolean);if(!a)return null;r.push(a),n+=a.length}return r}getOperand(e){let t;if(t=this.memory(e)){let n=0,r=1;/^WORD PTR$/i.test(`${this.tokens[e].lexeme} ${this.tokens[e+1].lexeme}`)?(n=2,r+=2):/^BYTE PTR$/i.test(`${this.tokens[e].lexeme} ${this.tokens[e+1].lexeme}`)&&(n=1,r+=2);let u=null;this.identifier(e+r-1)&&(u=t[r-1].lexeme,r+=1,r<t.length&&this.colon(e+r-1)&&(r+=1));let o=!0,a=null,c=null,d=null,p=!0;for(let b of t.slice(r,t.length-1))b.type===11?o=!0:b.type===12?o=!1:b.type===0?(d=new V(b),p=o):/BP|BX/i.test(b.lexeme)?a=new J(b):c=new J(b);return new U(this.tokens[e],a,c,d,p,n,u)}if(this.segoff(e))return new He(this.tokens[e],new V(this.tokens[e]),new V(this.tokens[e+2]));if(this.immediate(e))return new V(this.tokens[e]);if(this.register(e))return new J(this.tokens[e]);if(this.label(e))return/^OFFSET$/i.test(this.tokens[e].lexeme)?new as(n=>new N(this.tokens[e+1]).getOffset(n)):new N(this.tokens[e])}isLineEnd(e){return e.type===15||e.type===13}};var wi=ze(Di());var Ft=class{constructor(){this.changes=new Set;this.data=new Uint8Array(Ft.SIZE),this.view=new DataView(this.data.buffer)}set(e,t,n=1,r=!0){if(e<0||e>=Ft.SIZE)throw Error(`Memory address has to be a positive integer less than ${Ft.SIZE}, given ${e}`);switch(n){case 1:this.view.setUint8(e,t),r&&this.changes.add(e);break;case 2:this.view.setUint16(e,t,!0),r&&(this.changes.add(e),this.changes.add(e+1));break;case 4:this.view.setUint32(e,t,!0),r&&(this.changes.add(e),this.changes.add(e+1),this.changes.add(e+2),this.changes.add(e+3));break;case 8:this.view.setBigUint64(e,BigInt(t),!0),r&&(this.changes.add(e),this.changes.add(e+1),this.changes.add(e+2),this.changes.add(e+3),this.changes.add(e+4),this.changes.add(e+5),this.changes.add(e+6),this.changes.add(e+7));break}}get(e,t){switch(t){case 1:return this.view.getUint8(e);case 2:return this.view.getUint16(e,!0);case 4:return this.view.getUint32(e,!0);case 8:return Number(this.view.getBigUint64(e,!0));default:return 0}}toString(e){return(0,wi.hexy)(Buffer.from(this.data),{offset:e,format:"twos",width:16,length:16*5})}},fs=Ft;fs.SIZE=1e6;var X=class{constructor(e){this.name=e;this._value=new Uint8Array(2),this.view=new DataView(this._value.buffer)}set value(e){this.view.setUint16(0,e,!0)}get value(){return this.view.getUint16(0,!0)}get signed(){return this.view.getInt16(0,!0)}},Ce=class extends X{constructor(e,t){super(e);this.parent=t;this.isLow=/L$/i.test(e)}set value(e){this.parent.view.setUint8(this.isLow?0:1,e)}get value(){return this.parent.view.getUint8(this.isLow?0:1)}get signed(){return this.parent.view.getInt8(this.isLow?0:1)}};var Ut=class extends X{get carry(){return this.getBit(0)}set carry(e){this.setBit(0,e)}get parity(){return this.getBit(2)}set parity(e){this.setBit(2,e)}get auxilliary(){return this.getBit(4)}set auxilliary(e){this.setBit(4,e)}get zero(){return this.getBit(6)}set zero(e){this.setBit(6,e)}get sign(){return this.getBit(7)}set sign(e){this.setBit(7,e)}get trap(){return this.getBit(8)}set trap(e){this.setBit(8,e)}get interrupt(){return this.getBit(9)}set interrupt(e){this.setBit(9,e)}get directional(){return this.getBit(10)}set directional(e){this.setBit(10,e)}get overflow(){return this.getBit(11)}set overflow(e){this.setBit(11,e)}getBit(e){return this.value&this.bitmask(e)?1:0}setBit(e,t){t?this.value|=this.bitmask(e):this.value&=~this.bitmask(e)}bitmask(e){return 1<<e}};var ms=class{constructor(){this.nodes=[];this.labels=[];this.instructions=[];this.dataLabels=[];this.procs=[];this.segments=[];this.startLabel=null;this.assume={};this.outBuffer=[];this.inBuffer=[];this.int=[];this.input=!1;let e=new X("AX"),t=new X("BX"),n=new X("CX"),r=new X("DX");this.registers={AX:e,AL:new Ce("AL",e),AH:new Ce("AH",e),BX:t,BL:new Ce("BL",t),BH:new Ce("BH",t),CX:n,CL:new Ce("CL",n),CH:new Ce("CH",n),DX:r,DL:new Ce("DL",r),DH:new Ce("DH",r),DI:new X("DI"),SI:new X("SI"),BP:new X("BP"),SP:new X("SP"),DS:new X("DS"),ES:new X("ES"),SS:new X("SS"),CS:new X("CS"),IP:new X("IP"),FLAG:new Ut("FLAG")},this.memory=new fs,this.registers.CS.value=1024,this.registers.SS.value=1024,this.registers.DS.value=1024,this.registers.SP.value=65535}load(e){this.source=e;let t=new Ye(e);this.nodes=t.parse(),this.labels=[],this.instructions=[],this.dataLabels=[],this.procs=[],this.segments=[],this.outBuffer=[],this.inBuffer=[],this.int=[],this.input=!1;for(let n of this.nodes)this.preprocess(n);for(let[n,r]of Object.entries(this.assume)){if(!r)continue;let u=this.segments.find(o=>o.name===r);if(u?.location)this.registers[n].value=u.location>>4;else throw new Error("Assumed segment does not exist")}if(this.push(65535),this.startLabel){let n=this.labels.find(r=>r.name===this.startLabel)||this.procs.find(r=>r.name===this.startLabel);n?.location?this.registers.IP.value=n.location-this.registers.CS.value*16||0:this.registers.IP.value=0}else this.registers.IP.value=0;this.int[0]=n=>{n.outBuffer.push("DIVIDE ERROR INTERRUPT")},this.int[4]=n=>{n.outBuffer.push("OVERFLOW INTERRUPT")},this.int[33]=n=>{switch(n.registers.AH.value){case 1:this.input=!0;break;case 2:this.outBuffer.push(String.fromCharCode(this.registers.DL.value));break}};for(let n in this.int)this.instructions.push(new mt(this,Number(n)))}preprocess(e){let t=this.registers.CS.value*16+this.registers.IP.value;if(e instanceof ge){let n=e.instruction.getBinary(this,e),r=Math.ceil(n.length/8);e.location=t,this.memory.set(t,parseInt(n,2),r),this.registers.IP.value+=r;let u=e.op1 instanceof N?e.op1:e.op2;if(u instanceof N&&u.size===0){let a=u.getNode(this);u.size=a instanceof Ze?a.size:2}let o=e.op1 instanceof U?e.op1:e.op2;if(o instanceof U&&o.base){let a=this.dataLabels.find(c=>c.name===o.base);a&&(o.size=a.size)}if(e.op2 instanceof V&&e.op1?.size===2&&(e.op2.size=2),e.op1&&e.op2&&e.op1.size<e.op2.size)throw new Error("Size mismatch between operands");if(e.op1&&!(e.op1 instanceof N)&&e.op1.size===0||e.op2&&!(e.op2 instanceof N)&&e.op2.size===0)throw new Error("Unknown operand size");this.instructions.push(e)}else if(e instanceof Ot)this.labels.push(e),this.preprocess(e.instrNode);else if(e instanceof Ze){e.location=t;for(let n of e.values)this.registers.IP.value+=n.writeToMemory(this,this.registers.CS.value*16+this.registers.IP.value,e.size);this.dataLabels.push(e)}else if(e instanceof Bt){let n=0;e.alignmentType===1&&t%2!==0?n=1:e.alignmentType===2&&t%16!==0?n=Math.ceil(t/16)*16-t:e.alignmentType===3&&t%256!==0&&(n=Math.ceil(t/256)*256-t),this.registers.IP.value+=n,this.segments.push(e),e.nodes.forEach(r=>this.preprocess(r))}else e instanceof Xe?(this.procs.push(e),e.nodes.forEach(n=>this.preprocess(n))):e instanceof Tt?this.startLabel=e.label:e instanceof Nt&&(this.assume.CS=e.cs,this.assume.DS=e.ds,this.assume.SS=e.ss,this.assume.ES=e.es)}hasNode(e,t){return e.token.id===t.token.id?!0:e.nodes?e.nodes.reduce((n,r)=>n||this.hasNode(r,t),!1):!1}get currentNode(){let e=this.registers.CS.value*16+this.registers.IP.value,t=this.instructions.find(n=>n.location===e)||this.dataLabels.find(n=>n.location===e);return t instanceof mt||(this.prevNode=t),t}step(){if(this.input)return;let e=this.currentNode;!e||(e instanceof ge?(e.execute(this),this.registers.IP.value+=e.size(this)):this.registers.IP.value+=e.totalSize)}run(){for(;this.registers.IP.value<this.instructions.length;)this.step()}push(e){this.memory.set(this.registers.SS.value*16+this.registers.SP.value,e,2),this.registers.SP.value-=2}pop(){return this.registers.SP.value+=2,this.memory.get(this.registers.SS.value*16+this.registers.SP.value,2)}};var xi=ze(require("vscode")),q=class{constructor(e,t){this.name=e;this._value=t}get value(){return this._value}set value(e){this._value=e,this._memory=void 0}get memory(){return this._memory===void 0&&typeof this._value=="string"&&(this._memory=new TextEncoder().encode(this._value)),this._memory}setMemory(e,t=0){let n=this.memory;!n||(n.set(e,t),this._memory=n,this._value=new TextDecoder().decode(n))}};var an=class extends Ai.EventEmitter{constructor(e){super();this.fileAccessor=e;this.cpu=new ms;this._sourceFile="";this.variables=new Map;this.sourceLines=[];this.instructions=[];this.starts=[];this.ends=[];this._currentLine=0;this.instruction=0;this.breakPoints=new Map;this.instructionBreakpoints=new Set;this.breakpointId=1;this.breakAddresses=new Map;this.otherExceptions=!1;this.ended=!1;this.loaded=!1;this.lastStop=0;this.lastLines=[];this.loopThreshold=100}get sourceFile(){return this._sourceFile}get currentLine(){let e=this.cpu.currentNode;return e instanceof mt?this.cpu.prevNode?.token.pos.line||this.sourceLines.length-1:e?e.token.pos.line:this.sourceLines.length-1}set currentLine(e){}async start(e,t,n){this.loaded=!1,await this.loadSource(this.normalizePathAndCasing(e)),!this.ended&&(n?(await this.verifyBreakpoints(this._sourceFile),t?(this.sendEvent("stopOnEntry"),this.sendEvent("output","console",`.m <memory address> (ex: .m [5] | .m cs:[5] | .m arr[5] | .m [bx + si + 5])
.i <instruction (ex: .i mov ax, 5)
`,this._sourceFile,1,1)):await this.continue()):await this.continue())}async continue(){if(this.ended){this.sendEvent("end");return}let e=null;for(;this.cpu.currentNode;){let t=this.breakPoints.get(this.normalizePathAndCasing(this._sourceFile));if(t){let n=t.filter(r=>r.line===this.currentLine&&r.id!==this.lastBreakpoint?.id);if(n.length>0){this.sendEvent("stopOnBreakpoint"),n[0].verified||(n[0].verified=!0,this.sendEvent("breakpointValidated",n[0])),e=n[0];break}}if(!await this.cpuStep(!0))return;this.reachedEOF()}e?this.lastBreakpoint=e:this.sendEvent("stopOnStep")}async step(){if(this.ended){this.sendEvent("end");return}!await this.cpuStep()||(this.reachedEOF(),this.sendEvent("stopOnStep"))}async cpuStep(e=!1){try{this.cpu.step();let t=this.cpu.currentNode,n=t?.token.pos.line||this.currentLine,r=t?.token.pos.column||1;for(;this.cpu.outBuffer.length>0;)this.cpu.outBuffer[0].length===1&&(this.cpu.registers.AL.value=this.cpu.outBuffer[0].charCodeAt(0)),this.sendEvent("output","out",this.cpu.outBuffer.shift(),this._sourceFile,n,r);if(this.cpu.input){if(this.cpu.inBuffer.length===0){let u=await xi.window.showInputBox({placeHolder:"Input",prompt:"Program asked for input",ignoreFocusOut:!0});if(!u&&e)return this.sendEvent("stopOnStep"),!1;u?u+="\r":u="\0";let o=u.split("");for(let a of o)this.cpu.inBuffer.push(a)}this.cpu.inBuffer.length!==0&&(this.cpu.registers.AL.value=this.cpu.inBuffer.shift().charCodeAt(0)),this.cpu.input=!1}}catch(t){let n=t,r=n.token?.pos.line||this.currentLine,u=n.token?.pos.column||1;return this.sendEvent("output","err",`Error at line ${r} column ${u}: ${n.message}
`,this._sourceFile,r,u),this.sendEvent("end"),this.ended=!0,console.error(n),!1}return!0}reachedEOF(){this.cpu.currentNode||(this.ended=!0)}stack(e,t){let n=this.getLine(),r=this.getWords(this.currentLine,n);r.push({name:"BOTTOM",line:-1,index:-1});let u=[];for(let o=e;o<Math.min(t,this.sourceLines.length);o++){let a={index:o,name:`${this.sourceLines[o]}(${o})`,file:this._sourceFile,line:this.currentLine,column:1};u.push(a)}return{frames:u,count:r.length}}getBreakpoints(e,t){return[1]}async setBreakPoint(e,t){e=this.normalizePathAndCasing(e);let n={verified:!1,line:t,id:this.breakpointId++},r=this.breakPoints.get(e);return r||(r=new Array,this.breakPoints.set(e,r)),r.push(n),await this.verifyBreakpoints(e),n}clearBreakPoint(e,t){let n=this.breakPoints.get(this.normalizePathAndCasing(e));if(n){let r=n.findIndex(u=>u.line===t);if(r>=0){let u=n[r];return n.splice(r,1),u}}}clearBreakpoints(e){this.breakPoints.delete(this.normalizePathAndCasing(e))}getLine(e){return this.sourceLines[e===void 0?this.currentLine:e].trim()}getWords(e,t){let n=/[a-z]+/gi,r=[],u;for(;u=n.exec(t);)r.push({name:u[0],line:e,index:u.index});return r}async loadSource(e){this._sourceFile!==e&&(this._sourceFile=this.normalizePathAndCasing(e),this.initializeContents(await this.fileAccessor.readFile(e)))}initializeContents(e){let t=new TextDecoder().decode(e);try{t+=`
`,this.loaded||(this.cpu=new ms,this.cpu.load(t),this.loaded=!0)}catch(n){let r=n,u=r.token?.pos.line||this.currentLine,o=r.token?.pos.column||1;this.sendEvent("output","err",`Error at line ${u} column ${o}: ${r.message}
`,this._sourceFile,u,o),this.sendEvent("end"),this.ended=!0,console.error(r);return}this.sourceLines=t.split(/\r?\n/),this.instructions=[],this.starts=[],this.instructions=[],this.ends=[];for(let n=0;n<this.sourceLines.length;n++){this.starts.push(this.instructions.length);let r=this.getWords(n,this.sourceLines[n]);for(let u of r)this.instructions.push(u);this.ends.push(this.instructions.length)}}async verifyBreakpoints(e){let t=this.breakPoints.get(e);t&&(await this.loadSource(e),t.forEach(n=>{if(!n.verified&&n.line<this.sourceLines.length){let r=[...this.cpu.instructions];r.sort((o,a)=>o.token.pos.line-a.token.pos.line);let u=r.find(o=>o.token.pos.line>=n.line);u&&(n.verified=!0,n.line!==u.token.pos.line?(n.line=u.token.pos.line,this.sendEvent("breakpointChanged","changed",n)):this.sendEvent("breakpointValidated",n))}}))}sendEvent(e,...t){setTimeout(()=>{this.emit(e,...t)},0)}normalizePathAndCasing(e){return this.fileAccessor.isWindows?e.replace(/\//g,"\\").toLowerCase():e.replace(/\\/g,"/").toLowerCase()}};var ki=ze(Si()),ys=ze(Pi());var Ae=class extends D.LoggingDebugSession{constructor(e){super("mock-debug.txt");this._variableHandles=new D.Handles;this._configurationDone=new ki.Subject;this._cancellationTokens=new Map;this._reportProgress=!1;this._progressId=1e4;this._cancelledProgressId=void 0;this._isProgressCancellable=!0;this._valuesInHex=!1;this._useInvalidatedEvent=!1;this._addressesInHex=!0;this.setDebuggerLinesStartAt1(!0),this.setDebuggerColumnsStartAt1(!0),this._runtime=new an(e),this._runtime.on("stopOnEntry",()=>{this.sendEvent(new D.StoppedEvent("entry",Ae.threadID))}),this._runtime.on("stopOnStep",()=>{this.sendEvent(new D.StoppedEvent("step",Ae.threadID))}),this._runtime.on("stopOnBreakpoint",()=>{this.sendEvent(new D.StoppedEvent("breakpoint",Ae.threadID))}),this._runtime.on("breakpointChanged",(t,n)=>{this.sendEvent(new D.BreakpointEvent(t,n))}),this._runtime.on("stopOnDataBreakpoint",()=>{this.sendEvent(new D.StoppedEvent("data breakpoint",Ae.threadID))}),this._runtime.on("stopOnInstructionBreakpoint",()=>{this.sendEvent(new D.StoppedEvent("instruction breakpoint",Ae.threadID))}),this._runtime.on("stopOnException",t=>{t?this.sendEvent(new D.StoppedEvent(`exception(${t})`,Ae.threadID)):this.sendEvent(new D.StoppedEvent("exception",Ae.threadID))}),this._runtime.on("breakpointValidated",t=>{this.sendEvent(new D.BreakpointEvent("changed",{verified:t.verified,id:t.id}))}),this._runtime.on("output",(t,n,r,u,o)=>{let a;switch(t){case"prio":a="important";break;case"out":a="stdout";break;case"err":a="stderr";break;default:a="console";break}let c=new D.OutputEvent(`${n}`,a);(n==="start"||n==="startCollapsed"||n==="end")&&(c.body.group=n,c.body.output=`group-${n}
`),c.body.source=this.createSource(r),c.body.line=this.convertDebuggerLineToClient(u),c.body.column=this.convertDebuggerColumnToClient(o),this.sendEvent(c)}),this._runtime.on("end",()=>{this.sendEvent(new D.TerminatedEvent)})}initializeRequest(e,t){t.supportsProgressReporting&&(this._reportProgress=!0),t.supportsInvalidatedEvent&&(this._useInvalidatedEvent=!0),e.body=e.body||{},e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!0,e.body.supportsStepBack=!1,e.body.supportsDataBreakpoints=!1,e.body.supportsCompletionsRequest=!0,e.body.supportsCancelRequest=!0,e.body.supportsBreakpointLocationsRequest=!0,e.body.supportsStepInTargetsRequest=!1,e.body.supportsExceptionFilterOptions=!1,e.body.supportsExceptionInfoRequest=!1,e.body.supportsSetVariable=!0,e.body.supportsSetExpression=!0,e.body.supportsDisassembleRequest=!1,e.body.supportsSteppingGranularity=!1,e.body.supportsInstructionBreakpoints=!1,e.body.supportsReadMemoryRequest=!0,e.body.supportsWriteMemoryRequest=!0,e.body.supportSuspendDebuggee=!0,e.body.supportTerminateDebuggee=!0,e.body.supportsFunctionBreakpoints=!1,e.body.supportsDelayedStackTraceLoading=!1,this.sendResponse(e),this.sendEvent(new D.InitializedEvent)}configurationDoneRequest(e,t){super.configurationDoneRequest(e,t),this._configurationDone.notify()}disconnectRequest(e,t,n){console.log(`disconnectRequest suspend: ${t.suspendDebuggee}, terminate: ${t.terminateDebuggee}`)}async attachRequest(e,t){return this.launchRequest(e,t)}async launchRequest(e,t){D.logger.setup(t.trace?D.Logger.LogLevel.Verbose:D.Logger.LogLevel.Stop,!1),await this._configurationDone.wait(1e3),await this._runtime.start(t.program,!!t.stopOnEntry,!t.noDebug),t.compileError?this.sendErrorResponse(e,{id:1001,format:"compile error: some fake error.",showUser:t.compileError==="show"?!0:t.compileError==="hide"?!1:void 0}):this.sendResponse(e)}async setBreakPointsRequest(e,t){let n=t.source.path,r=t.lines||[];this._runtime.clearBreakpoints(n);let u=r.map(async a=>{let{verified:c,line:d,id:p}=await this._runtime.setBreakPoint(this._runtime.normalizePathAndCasing(n),this.convertClientLineToDebugger(a)),b=new D.Breakpoint(c,this.convertDebuggerLineToClient(d));return b.id=p,b}),o=await Promise.all(u);e.body={breakpoints:o},this.sendResponse(e)}breakpointLocationsRequest(e,t,n){if(t.source.path){let r=this._runtime.getBreakpoints(t.source.path,this.convertClientLineToDebugger(t.line));e.body={breakpoints:r.map(u=>({line:t.line,column:this.convertDebuggerColumnToClient(u)}))}}else e.body={breakpoints:[]};this.sendResponse(e)}threadsRequest(e){e.body={threads:[new D.Thread(Ae.threadID,"thread 1"),new D.Thread(Ae.threadID+1,"thread 2")]},this.sendResponse(e)}stackTraceRequest(e,t){let n=typeof t.startFrame=="number"?t.startFrame:0,r=typeof t.levels=="number"?t.levels:1e3,u=n+r,o=this._runtime.stack(n,u);e.body={stackFrames:o.frames.map((a,c)=>{let d=new D.StackFrame(a.index,a.name,this.createSource(a.file),this.convertDebuggerLineToClient(a.line));if(typeof a.column=="number"&&(d.column=this.convertDebuggerColumnToClient(a.column)),typeof a.instruction=="number"){let p=this.formatAddress(a.instruction);d.name=`${a.name} ${p}`,d.instructionPointerReference=p}return d}),totalFrames:o.count},this.sendResponse(e)}scopesRequest(e,t){e.body={scopes:[new D.Scope("Registers",this._variableHandles.create("registers"),!1),new D.Scope("Data",this._variableHandles.create("data"),!1),new D.Scope("Memory",this._variableHandles.create("memory"),!0)]},this.sendResponse(e)}async writeMemoryRequest(e,{data:t,memoryReference:n,offset:r=0}){let u=this._variableHandles.get(Number(n));if(typeof u=="object"){let o=ys.toByteArray(t);u.setMemory(o,r),e.body={bytesWritten:o.length}}else e.body={bytesWritten:0};this.sendResponse(e),this.sendEvent(new D.InvalidatedEvent(["variables"]))}async readMemoryRequest(e,{offset:t=0,count:n,memoryReference:r}){let u=this._variableHandles.get(Number(r));if(typeof u=="object"&&u.memory){let o=u.memory.subarray(Math.min(t,u.memory.length),Math.min(t+n,u.memory.length));e.body={address:t.toString(),data:ys.fromByteArray(o),unreadableBytes:n-o.length}}else e.body={address:t.toString(),data:"",unreadableBytes:n};this.sendResponse(e)}async variablesRequest(e,t,n){let r=[],u=this._variableHandles.get(t.variablesReference);if(u==="registers"){if(r=Object.values(this._runtime.cpu.registers).map(o=>new q(o.name,o instanceof Ut?[new q("C",o.carry?1:0),new q("P",o.parity?1:0),new q("A",o.auxilliary?1:0),new q("Z",o.zero?1:0),new q("S",o.sign?1:0),new q("T",o.trap?1:0),new q("I",o.interrupt?1:0),new q("D",o.directional?1:0),new q("O",o.overflow?1:0)]:o.value)),this._valuesInHex)for(let o of r)if(typeof o.value=="object")for(let a of o.value)a.value=a.value.toString(16);else o.value=o.value.toString(16)}else if(u==="data")r=Object.values(this._runtime.cpu.dataLabels).filter(o=>o.location).map(o=>{let a=[];for(let d=0;d<o.totalSize;d+=o.size)a.push(this._runtime.cpu.memory.get(o.location+d,o.size));let c=a.map((d,p)=>new q(p.toString(this._valuesInHex?16:10),d));return new q(o.name,o.values.length===1?a[0]:c)});else if(u==="memory"){if(r=[...this._runtime.cpu.memory.changes].map(o=>new q(o.toString(),this._runtime.cpu.memory.get(o,1))),r.sort((o,a)=>o.name.localeCompare(a.name)),this._valuesInHex)for(let o of r)o.value=o.value.toString(16)}else u&&Array.isArray(u.value)&&(r=u.value);e.body={variables:r.map(o=>this.convertFromRuntime(o))},this.sendResponse(e)}setVariableRequest(e,t){let n=this._variableHandles.get(t.variablesReference),r;if(n==="registers"){r=new q(t.name,0);let o=_e(t.value);o&&(r.value=o.value,this._runtime.cpu.registers[t.name].value=o.value)}n==="data"&&(r=new q(t.name,0),r.value=t.value,this._runtime.cpu.dataLabels.find(o=>o.name===t.name).values[0].value=parseInt(t.value)),n==="memory"&&(r=new q(t.name,0),r.value=t.value,this._runtime.cpu.memory.set(parseInt(t.name),r.value,1));let u=r||(n instanceof q&&n.value instanceof Array?n.value.find(o=>o.name===t.name):void 0);u&&(u.value=this.convertToRuntime(t.value),e.body=this.convertFromRuntime(u),u.memory&&u.reference&&this.sendEvent(new D.MemoryEvent(String(u.reference),0,u.memory.length))),this.sendResponse(e)}async continueRequest(e,t){await this._runtime.continue(),this.sendResponse(e)}async nextRequest(e,t){await this._runtime.step(),this.sendResponse(e)}stepBackRequest(e,t){}stepInTargetsRequest(e,t){}async stepInRequest(e,t){await this._runtime.step(),this.sendResponse(e)}stepOutRequest(e,t){}async evaluateRequest(e,t){let n="",r=t.expression.startsWith(".m"),u=t.expression.startsWith(".i");try{if(t.context==="repl"&&r){let o=new Ye(t.expression.slice(2),"watch").parse();if(o.length>0&&o[0]instanceof $e){let a=o[0]instanceof U?o[0].getAddress(this._runtime.cpu):o[0].getUnsigned(this._runtime.cpu);n=this._runtime.cpu.memory.toString(a)}else n="Invalid command"}else if(t.context==="repl"&&u){let o=new Ye(t.expression.slice(2)).parse();o.length===0?n="Invalid command":o[0]instanceof ge&&o[0].execute(this._runtime.cpu)}else{let o=new Ye(t.expression,"watch").parse();o.length===0?n="Invalid command":o[0]instanceof $e?n=o[0].getValue(this._runtime.cpu).toString():n="Invalid command"}}catch(o){n=o.message}e.body={result:n,variablesReference:0},this.sendResponse(e)}completionsRequest(e,t){e.body={targets:nn.map(n=>({label:n.mnemonic}))},this.sendResponse(e)}cancelRequest(e,t){t.requestId&&this._cancellationTokens.set(t.requestId,!0),t.progressId&&(this._cancelledProgressId=t.progressId)}customRequest(e,t,n){e==="toggleFormatting"?(this._valuesInHex=!this._valuesInHex,this._useInvalidatedEvent&&this.sendEvent(new D.InvalidatedEvent(["variables"])),this.sendResponse(t)):super.customRequest(e,t,n)}convertToRuntime(e){if(e=e.trim(),e==="true")return!0;if(e==="false")return!1;if(e[0]==="'"||e[0]==='"')return e.substr(1,e.length-2);let t=parseFloat(e);return isNaN(t)?e:t}convertFromRuntime(e){let t={name:e.name,value:"???",type:typeof e.value,variablesReference:0,evaluateName:e.name};if(Array.isArray(e.value))t.value="Object",e.reference??(e.reference=this._variableHandles.create(e)),t.variablesReference=e.reference;else switch(typeof e.value){case"number":Math.round(e.value)===e.value?(t.value=this.formatNumber(e.value),t.__vscodeVariableMenuContext="simple",t.type="integer"):(t.value=e.value.toString(),t.type="float");break;case"string":t.value=`"${e.value}"`;break;case"boolean":t.value=e.value?"true":"false";break;default:t.value=typeof e.value;break}return e.memory&&(e.reference??(e.reference=this._variableHandles.create(e)),t.memoryReference=String(e.reference)),t}formatAddress(e,t=8){return this._addressesInHex?"0x"+e.toString(16).padStart(8,"0"):e.toString(10)}formatNumber(e){return this._valuesInHex?"0x"+e.toString(16):e.toString(10)}createSource(e){return new D.Source((0,Ci.basename)(e),this.convertDebuggerPathToClient(e),void 0,void 0,"8086-adapter-data")}},vs=Ae;vs.threadID=1;function Bi(s,e){s.subscriptions.push(L.commands.registerCommand("extension.8086-assembly-debugger.runEditorContents",n=>{let r=n;!r&&L.window.activeTextEditor&&(r=L.window.activeTextEditor.document.uri),r&&L.debug.startDebugging(void 0,{type:"8086",name:"Run File",request:"launch",program:r.fsPath},{noDebug:!0})}),L.commands.registerCommand("extension.8086-assembly-debugger.debugEditorContents",n=>{let r=n;!r&&L.window.activeTextEditor&&(r=L.window.activeTextEditor.document.uri),r&&L.debug.startDebugging(void 0,{type:"8086",name:"Debug File",request:"launch",program:r.fsPath,stopOnEntry:!0})}),L.commands.registerCommand("extension.8086-assembly-debugger.toggleFormatting",n=>{let r=L.debug.activeDebugSession;r&&r.customRequest("toggleFormatting")})),s.subscriptions.push(L.commands.registerCommand("extension.8086-assembly-debugger.getProgramName",n=>L.window.showInputBox({placeHolder:"Please enter the name of an assembly file in the workspace folder",value:"test.asm"})));let t=new Ti;s.subscriptions.push(L.debug.registerDebugConfigurationProvider("8086",t)),s.subscriptions.push(L.debug.registerDebugConfigurationProvider("8086",{provideDebugConfigurations(n){return[{name:"Dynamic Launch",request:"launch",type:"8086",program:"${file}"},{name:"Another Dynamic Launch",request:"launch",type:"8086",program:"${file}"},{name:"8086 Launch",request:"launch",type:"8086",program:"${file}"}]}},L.DebugConfigurationProviderTriggerKind.Dynamic)),e||(e=new Ni),s.subscriptions.push(L.debug.registerDebugAdapterDescriptorFactory("8086",e)),"dispose"in e&&s.subscriptions.push(e)}var Ti=class{resolveDebugConfiguration(e,t,n){if(!t.type&&!t.request&&!t.name){let r=L.window.activeTextEditor;r&&r.document.languageId==="plaintext"&&(t.type="8086",t.name="Launch",t.request="launch",t.program="${file}",t.stopOnEntry=!0)}return t.program?t:L.window.showInformationMessage("Cannot find a program to debug").then(r=>{})}},Po={isWindows:!1,async readFile(s){let e;try{e=Oi(s)}catch{return new TextEncoder().encode(`cannot read '${s}'`)}return await L.workspace.fs.readFile(e)},async writeFile(s,e){await L.workspace.fs.writeFile(Oi(s),e)}};function Oi(s){try{return L.Uri.file(s)}catch{return L.Uri.parse(s)}}var Ni=class{createDebugAdapterDescriptor(e){return new L.DebugAdapterInlineImplementation(new vs(Po))}};function Co(s){Bi(s)}function ko(){}
/*! https://mths.be/punycode v1.3.2 by @mathias */
